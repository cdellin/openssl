<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>openssl: crypto/pkcs7/pk7_doit.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">openssl
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_53403d93963d3f5d2fcffd0698f5bddb.html">crypto</a></li><li class="navelem"><a class="el" href="dir_4c2058c45cb81171e0b597ef8ac77d63.html">pkcs7</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">pk7_doit.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="cryptlib_8h_source.html">cryptlib.h</a>&quot;</code><br/>
<code>#include &lt;openssl/rand.h&gt;</code><br/>
<code>#include &lt;openssl/objects.h&gt;</code><br/>
<code>#include &lt;openssl/x509.h&gt;</code><br/>
<code>#include &lt;openssl/x509v3.h&gt;</code><br/>
<code>#include &lt;openssl/err.h&gt;</code><br/>
</div>
<p><a href="pk7__doit_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a0fb23f12a84dea91d6d0c2e9fd202e71"><td class="memItemLeft" align="right" valign="top"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a0fb23f12a84dea91d6d0c2e9fd202e71">PKCS7_dataInit</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *bio)</td></tr>
<tr class="memitem:a20b7af47df8150c9269c8066a86baac4"><td class="memItemLeft" align="right" valign="top"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a20b7af47df8150c9269c8066a86baac4">PKCS7_dataDecode</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *pkey, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *in_bio, <a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *pcert)</td></tr>
<tr class="memitem:adda922d753824551b5c081373ccbd8a5"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#adda922d753824551b5c081373ccbd8a5">PKCS7_dataFinal</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *bio)</td></tr>
<tr class="memitem:a76d0aa3f479954122b66f39c66760a0e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a76d0aa3f479954122b66f39c66760a0e">PKCS7_SIGNER_INFO_sign</a> (<a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *si)</td></tr>
<tr class="memitem:ae20129e7b71aa1757f4d26a3068b4e80"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#ae20129e7b71aa1757f4d26a3068b4e80">PKCS7_dataVerify</a> (<a class="el" href="ossl__typ_8h.html#a3a2b800bae08729d11bc28f12b795597">X509_STORE</a> *cert_store, <a class="el" href="ossl__typ_8h.html#ae681945a2cf88d6337137dc0260a1545">X509_STORE_CTX</a> *ctx, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *bio, <a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *si)</td></tr>
<tr class="memitem:a43129e7012c9aba2b945584972810198"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a43129e7012c9aba2b945584972810198">PKCS7_signatureVerify</a> (<a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *bio, <a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *si, <a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *x509)</td></tr>
<tr class="memitem:a4d1b1b17269f8a25c410711d6f1cb181"><td class="memItemLeft" align="right" valign="top"><a class="el" href="pkcs7_8h.html#a3f5400dcd95708494b81eaae75743fcf">PKCS7_ISSUER_AND_SERIAL</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a4d1b1b17269f8a25c410711d6f1cb181">PKCS7_get_issuer_and_serial</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, int idx)</td></tr>
<tr class="memitem:a648d6d429b4ff13f3a1250890d4ce7ff"><td class="memItemLeft" align="right" valign="top"><a class="el" href="asn1_8h.html#a7895e03d9fee2bc4963faf2a31a9439e">ASN1_TYPE</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a648d6d429b4ff13f3a1250890d4ce7ff">PKCS7_get_signed_attribute</a> (<a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *si, int <a class="el" href="x509_8h.html#a7235ef62e89328f5155846dc59c6fc37">nid</a>)</td></tr>
<tr class="memitem:a63a85c504c51f36bbb8c5d29916cc3fd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="asn1_8h.html#a7895e03d9fee2bc4963faf2a31a9439e">ASN1_TYPE</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a63a85c504c51f36bbb8c5d29916cc3fd">PKCS7_get_attribute</a> (<a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *si, int <a class="el" href="x509_8h.html#a7235ef62e89328f5155846dc59c6fc37">nid</a>)</td></tr>
<tr class="memitem:abf8691133031089e545fe535e3b79e15"><td class="memItemLeft" align="right" valign="top"><a class="el" href="ossl__typ_8h.html#afbd05e94e0f0430a2b729473efec88c1">ASN1_OCTET_STRING</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#abf8691133031089e545fe535e3b79e15">PKCS7_digest_from_attributes</a> (<a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="x509_8h.html#aa4f1a62a9d2dd8cb6780fe2713737c0f">X509_ATTRIBUTE</a>)*sk)</td></tr>
<tr class="memitem:aa5da0604e0ffb4c32e7a6a50cba84cd3"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#aa5da0604e0ffb4c32e7a6a50cba84cd3">PKCS7_set_signed_attributes</a> (<a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *p7si, <a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="x509_8h.html#aa4f1a62a9d2dd8cb6780fe2713737c0f">X509_ATTRIBUTE</a>)*sk)</td></tr>
<tr class="memitem:ae1b3b3bc41a641cdceddd40df2c326b8"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#ae1b3b3bc41a641cdceddd40df2c326b8">PKCS7_set_attributes</a> (<a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *p7si, <a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="x509_8h.html#aa4f1a62a9d2dd8cb6780fe2713737c0f">X509_ATTRIBUTE</a>)*sk)</td></tr>
<tr class="memitem:af7b6232f8890fe393aef4241908dfca0"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#af7b6232f8890fe393aef4241908dfca0">PKCS7_add_signed_attribute</a> (<a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *p7si, int <a class="el" href="x509_8h.html#a7235ef62e89328f5155846dc59c6fc37">nid</a>, int atrtype, void *value)</td></tr>
<tr class="memitem:a0d8cf40087f5fc4f4ab060f70d6da210"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__doit_8c.html#a0d8cf40087f5fc4f4ab060f70d6da210">PKCS7_add_attribute</a> (<a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *p7si, int <a class="el" href="x509_8h.html#a7235ef62e89328f5155846dc59c6fc37">nid</a>, int atrtype, void *value)</td></tr>
</table>
<h2>Function Documentation</h2>
<a class="anchor" id="a0d8cf40087f5fc4f4ab060f70d6da210"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_add_attribute </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>p7si</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>nid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>atrtype</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>value</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01248">1248</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordflow">return</span>(add_attribute(&amp;(p7si-&gt;unauth_attr),<a class="code" href="pem_8h.html#a85baed467a8a5107268fae0ceb6cb9b6">nid</a>,atrtype,value));</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="af7b6232f8890fe393aef4241908dfca0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_add_signed_attribute </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>p7si</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>nid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>atrtype</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>value</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01242">1242</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordflow">return</span>(add_attribute(&amp;(p7si-&gt;auth_attr),<a class="code" href="pem_8h.html#a85baed467a8a5107268fae0ceb6cb9b6">nid</a>,atrtype,value));</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a20b7af47df8150c9269c8066a86baac4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a>* PKCS7_dataDecode </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *&#160;</td>
          <td class="paramname"><em>pkey</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>in_bio</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *&#160;</td>
          <td class="paramname"><em>pcert</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l00420">420</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordtype">int</span> i,j;</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *<a class="code" href="ideatest_8c.html#afdf65de9e264331943a9e5a248271311">out</a>=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,*btmp=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,*etmp=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,*bio=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structX509__algor__st.html">X509_ALGOR</a> *xa;</div>
<div class="line">        <a class="code" href="structasn1__string__st.html">ASN1_OCTET_STRING</a> *data_body=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="structenv__md__st.html">EVP_MD</a> *evp_md;</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="structevp__cipher__st.html">EVP_CIPHER</a> *evp_cipher=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structevp__cipher__ctx__st.html">EVP_CIPHER_CTX</a> *evp_ctx=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structX509__algor__st.html">X509_ALGOR</a> *enc_alg=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structX509__algor__st.html">X509_ALGOR</a>) *md_sk=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structpkcs7__recip__info__st.html">PKCS7_RECIP_INFO</a>) *rsk=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structpkcs7__recip__info__st.html">PKCS7_RECIP_INFO</a> *ri=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ek = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, *tkey = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">       <span class="keywordtype">int</span> eklen = 0, tkeylen = 0;</div>
<div class="line"></div>
<div class="line">        i=<a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#acd92bf461725525e7785077578ccf226">type</a>);</div>
<div class="line">        p7-&gt;<a class="code" href="structpkcs7__st.html#a347c4591ec3bcf75f4dd86b430b20426">state</a>=<a class="code" href="pkcs7_8h.html#a887df905e3120a68183bc75ceaa86d70">PKCS7_S_HEADER</a>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (i)</div>
<div class="line">                {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a085f07bc1100332366a5675145f8fea9">NID_pkcs7_signed</a>:</div>
<div class="line">                data_body=PKCS7_get_octet_string(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;<a class="code" href="structpkcs7__signed__st.html#a41182027c38487c5be24e8609f4590f8">contents</a>);</div>
<div class="line">                md_sk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;md_algs;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a320f30f595981af7aa071c54922a7f03">NID_pkcs7_signedAndEnveloped</a>:</div>
<div class="line">                rsk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;recipientinfo;</div>
<div class="line">                md_sk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;md_algs;</div>
<div class="line">                data_body=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;<a class="code" href="structpkcs7__signedandenveloped__st.html#a13b7235eaaab4212ab646d69c10c8012">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#ab4d08c0f1b94885ea0d0380ef4745c7b">enc_data</a>;</div>
<div class="line">                enc_alg=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;<a class="code" href="structpkcs7__signedandenveloped__st.html#a13b7235eaaab4212ab646d69c10c8012">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#af6c78a84b4ca86334dfc04a072ce1117">algorithm</a>;</div>
<div class="line">                evp_cipher=<a class="code" href="evp_8h.html#a359c5ec316dfeb6d04e2f146d9b0484d">EVP_get_cipherbyobj</a>(enc_alg-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a>);</div>
<div class="line">                <span class="keywordflow">if</span> (evp_cipher == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#ae585c8d2054c9d5fb68748f42dfc9c9e">PKCS7_F_PKCS7_DATADECODE</a>,<a class="code" href="pkcs7_8h.html#a300f59dbb3087508c309164325c484af">PKCS7_R_UNSUPPORTED_CIPHER_TYPE</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a4587e848643383571699c4b1fdaf5710">NID_pkcs7_enveloped</a>:</div>
<div class="line">                rsk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;recipientinfo;</div>
<div class="line">                enc_alg=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;<a class="code" href="structpkcs7__enveloped__st.html#a70fb3ace75518cf782f9e0330f4a140e">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#af6c78a84b4ca86334dfc04a072ce1117">algorithm</a>;</div>
<div class="line">                data_body=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;<a class="code" href="structpkcs7__enveloped__st.html#a70fb3ace75518cf782f9e0330f4a140e">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#ab4d08c0f1b94885ea0d0380ef4745c7b">enc_data</a>;</div>
<div class="line">                evp_cipher=<a class="code" href="evp_8h.html#a359c5ec316dfeb6d04e2f146d9b0484d">EVP_get_cipherbyobj</a>(enc_alg-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a>);</div>
<div class="line">                <span class="keywordflow">if</span> (evp_cipher == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#ae585c8d2054c9d5fb68748f42dfc9c9e">PKCS7_F_PKCS7_DATADECODE</a>,<a class="code" href="pkcs7_8h.html#a300f59dbb3087508c309164325c484af">PKCS7_R_UNSUPPORTED_CIPHER_TYPE</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#ae585c8d2054c9d5fb68748f42dfc9c9e">PKCS7_F_PKCS7_DATADECODE</a>,<a class="code" href="pkcs7_8h.html#a852a7427b8e37e3d1fbddc4497ec275d">PKCS7_R_UNSUPPORTED_CONTENT_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* We will be checking the signature */</span></div>
<div class="line">        <span class="keywordflow">if</span> (md_sk != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#a94c75bbf81b8ad2a5ae09b10c8e47719">sk_X509_ALGOR_num</a>(md_sk); i++)</div>
<div class="line">                        {</div>
<div class="line">                        xa=<a class="code" href="safestack_8h.html#a6f0738d8fab06b164ea825826b366fd0">sk_X509_ALGOR_value</a>(md_sk,i);</div>
<div class="line">                        <span class="keywordflow">if</span> ((btmp=<a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio__md_8c.html#a2d39e4a3c1f89551732fb39ce8df19fb">BIO_f_md</a>())) == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#ae585c8d2054c9d5fb68748f42dfc9c9e">PKCS7_F_PKCS7_DATADECODE</a>,<a class="code" href="err_8h.html#a1a872529560db1107b62b62c935e6c7d">ERR_R_BIO_LIB</a>);</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                                }</div>
<div class="line"></div>
<div class="line">                        j=<a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(xa-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a>);</div>
<div class="line">                        evp_md=<a class="code" href="evp_8h.html#af21731974d1c9b9467b3bf209d378e36">EVP_get_digestbynid</a>(j);</div>
<div class="line">                        <span class="keywordflow">if</span> (evp_md == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#ae585c8d2054c9d5fb68748f42dfc9c9e">PKCS7_F_PKCS7_DATADECODE</a>,<a class="code" href="pkcs7_8h.html#aae13443a6d48b37b1889168732007410">PKCS7_R_UNKNOWN_DIGEST_TYPE</a>);</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                                }</div>
<div class="line"></div>
<div class="line">                        <a class="code" href="evp_8h.html#ac18e24ee9b5fde311b117ed697dffc15">BIO_set_md</a>(btmp,evp_md);</div>
<div class="line">                        <span class="keywordflow">if</span> (out == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                out=btmp;</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                                <a class="code" href="bio_8h.html#a4e509280cddd4eb3537fe7e3bc0827a9">BIO_push</a>(out,btmp);</div>
<div class="line">                        btmp=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (evp_cipher != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="des_8c.html#a6a4ff80275090619f35902b61a8c6bf6">key</a>[<a class="code" href="evp_8h.html#a9646a5fcb0387590176a8bdf6d529685">EVP_MAX_KEY_LENGTH</a>];</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> iv[<a class="code" href="evp_8h.html#a80893bc2dbae769441bf6a042cf4069e">EVP_MAX_IV_LENGTH</a>];</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;</div>
<div class="line">                <span class="keywordtype">int</span> keylen,ivlen;</div>
<div class="line">                <span class="keywordtype">int</span> max;</div>
<div class="line">                <a class="code" href="structx509__object__st.html">X509_OBJECT</a> ret;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">                <span class="keywordflow">if</span> ((etmp=<a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio__enc_8c.html#ae38a2c0160131c560c98fbf63d1eb65d">BIO_f_cipher</a>())) == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#ae585c8d2054c9d5fb68748f42dfc9c9e">PKCS7_F_PKCS7_DATADECODE</a>,<a class="code" href="err_8h.html#a1a872529560db1107b62b62c935e6c7d">ERR_R_BIO_LIB</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                <span class="comment">/* It was encrypted, we need to decrypt the secret key</span></div>
<div class="line"><span class="comment">                 * with the private key */</span></div>
<div class="line"></div>
<div class="line">                <span class="comment">/* Find the recipientInfo which matches the passed certificate</span></div>
<div class="line"><span class="comment">                 * (if any)</span></div>
<div class="line"><span class="comment">                 */</span></div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (pcert)</div>
<div class="line">                        {</div>
<div class="line">                        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#aaf938089edc5c86b468001186bfacbc8">sk_PKCS7_RECIP_INFO_num</a>(rsk); i++)</div>
<div class="line">                                {</div>
<div class="line">                                ri=<a class="code" href="safestack_8h.html#adc3552a5f950bb1f68425ac1042f7d7c">sk_PKCS7_RECIP_INFO_value</a>(rsk,i);</div>
<div class="line">                                <span class="keywordflow">if</span> (!pkcs7_cmp_ri(ri, pcert))</div>
<div class="line">                                        <span class="keywordflow">break</span>;</div>
<div class="line">                                ri=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                                }</div>
<div class="line">                        <span class="keywordflow">if</span> (ri == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#ae585c8d2054c9d5fb68748f42dfc9c9e">PKCS7_F_PKCS7_DATADECODE</a>,</div>
<div class="line">                                      <a class="code" href="pkcs7_8h.html#a7a4047baa4b989d8908a73b0a1cb7029">PKCS7_R_NO_RECIPIENT_MATCHES_CERTIFICATE</a>);</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                                }</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                <span class="comment">/* If we haven&#39;t got a certificate try each ri in turn */</span></div>
<div class="line">                <span class="keywordflow">if</span> (pcert == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <span class="comment">/* Always attempt to decrypt all rinfo even</span></div>
<div class="line"><span class="comment">                         * after success as a defence against MMA timing</span></div>
<div class="line"><span class="comment">                         * attacks.</span></div>
<div class="line"><span class="comment">                         */</span></div>
<div class="line">                        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#aaf938089edc5c86b468001186bfacbc8">sk_PKCS7_RECIP_INFO_num</a>(rsk); i++)</div>
<div class="line">                                {</div>
<div class="line">                                ri=<a class="code" href="safestack_8h.html#adc3552a5f950bb1f68425ac1042f7d7c">sk_PKCS7_RECIP_INFO_value</a>(rsk,i);</div>
<div class="line">                                </div>
<div class="line">                                <span class="keywordflow">if</span> (pkcs7_decrypt_rinfo(&amp;ek, &amp;eklen,</div>
<div class="line">                                                        ri, pkey) &lt; 0)</div>
<div class="line">                                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                                <a class="code" href="err_8c.html#ae562e57f2e66f238d774cbfddc6bf7a4">ERR_clear_error</a>();</div>
<div class="line">                                }</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                        <span class="comment">/* Only exit on fatal errors, not decrypt failure */</span></div>
<div class="line">                        <span class="keywordflow">if</span> (pkcs7_decrypt_rinfo(&amp;ek, &amp;eklen, ri, pkey) &lt; 0)</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                        <a class="code" href="err_8c.html#ae562e57f2e66f238d774cbfddc6bf7a4">ERR_clear_error</a>();</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                evp_ctx=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                <a class="code" href="evp_8h.html#a04d02269f6bd11231243c65acce8f57e">BIO_get_cipher_ctx</a>(etmp,&amp;evp_ctx);</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#aab11ae066491958c229882a364c3feb8">EVP_CipherInit_ex</a>(evp_ctx,evp_cipher,<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,0) &lt;= 0)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#ab4235d136f646de5e37bc7521bafedc8">EVP_CIPHER_asn1_to_param</a>(evp_ctx,enc_alg-&gt;<a class="code" href="structX509__algor__st.html#a0c0f294d859665c5b1e6d86c695ac4e1">parameter</a>) &lt; 0)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="comment">/* Generate random key as MMA defence */</span></div>
<div class="line">                tkeylen = <a class="code" href="evp_8h.html#a59acb66206fbf0e0c2e6789983db3dd7">EVP_CIPHER_CTX_key_length</a>(evp_ctx);</div>
<div class="line">                tkey = <a class="code" href="crypto_8h.html#afdb80d14aed3b15d0ef71f72a872310d">OPENSSL_malloc</a>(tkeylen);</div>
<div class="line">                <span class="keywordflow">if</span> (!tkey)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#a2f171ee3d2e29079c553d8cfafeaadaf">EVP_CIPHER_CTX_rand_key</a>(evp_ctx, tkey) &lt;= 0)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="keywordflow">if</span> (ek == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        ek = tkey;</div>
<div class="line">                        eklen = tkeylen;</div>
<div class="line">                        tkey = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (eklen != <a class="code" href="evp_8h.html#a59acb66206fbf0e0c2e6789983db3dd7">EVP_CIPHER_CTX_key_length</a>(evp_ctx)) {</div>
<div class="line">                        <span class="comment">/* Some S/MIME clients don&#39;t use the same key</span></div>
<div class="line"><span class="comment">                         * and effective key length. The key length is</span></div>
<div class="line"><span class="comment">                         * determined by the size of the decrypted RSA key.</span></div>
<div class="line"><span class="comment">                         */</span></div>
<div class="line">                        <span class="keywordflow">if</span>(!<a class="code" href="evp_8h.html#ad790f422c8622c30a4e9d79ba6d444e2">EVP_CIPHER_CTX_set_key_length</a>(evp_ctx, eklen))</div>
<div class="line">                                {</div>
<div class="line">                                <span class="comment">/* Use random key as MMA defence */</span></div>
<div class="line">                                <a class="code" href="crypto_8h.html#a2aa47e40c63b05d00e9a780592f2a2b8">OPENSSL_cleanse</a>(ek, eklen);</div>
<div class="line">                                <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(ek);</div>
<div class="line">                                ek = tkey;</div>
<div class="line">                                eklen = tkeylen;</div>
<div class="line">                                tkey = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                                }</div>
<div class="line">                } </div>
<div class="line">                <span class="comment">/* Clear errors so we don&#39;t leak information useful in MMA */</span></div>
<div class="line">                <a class="code" href="err_8c.html#ae562e57f2e66f238d774cbfddc6bf7a4">ERR_clear_error</a>();</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#aab11ae066491958c229882a364c3feb8">EVP_CipherInit_ex</a>(evp_ctx,<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,ek,<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,0) &lt;= 0)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (ek)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="crypto_8h.html#a2aa47e40c63b05d00e9a780592f2a2b8">OPENSSL_cleanse</a>(ek,eklen);</div>
<div class="line">                        <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(ek);</div>
<div class="line">                       ek = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">if</span> (tkey)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="crypto_8h.html#a2aa47e40c63b05d00e9a780592f2a2b8">OPENSSL_cleanse</a>(tkey,tkeylen);</div>
<div class="line">                        <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(tkey);</div>
<div class="line">                       tkey = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (out == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        out=etmp;</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                        <a class="code" href="bio_8h.html#a4e509280cddd4eb3537fe7e3bc0827a9">BIO_push</a>(out,etmp);</div>
<div class="line">                etmp=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if 1</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#a9e179c864c647a38e504334fac8cc875">PKCS7_is_detached</a>(p7) || (in_bio != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>))</div>
<div class="line">                {</div>
<div class="line">                bio=in_bio;</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">else</span> </div>
<div class="line">                {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>                bio=<a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio_8h.html#aa00c1ff95f6d83e358d2daa6eca3e724">BIO_s_mem</a>());</div>
<div class="line">                <span class="comment">/* We need to set this so that when we have read all</span></div>
<div class="line"><span class="comment">                 * the data, the encrypt BIO, if present, will read</span></div>
<div class="line"><span class="comment">                 * EOF and encode the last few bytes */</span></div>
<div class="line">                <a class="code" href="bio_8h.html#a11c737cf2f36d5a7f681590b6c0a2cc3">BIO_set_mem_eof_return</a>(bio,0);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (data_body-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a> &gt; 0)</div>
<div class="line">                        <a class="code" href="bio_8h.html#a7b4c64ffdc342154cf923744210a8429">BIO_write</a>(bio,(<span class="keywordtype">char</span> *)data_body-&gt;<a class="code" href="structasn1__string__st.html#a275a9784693f470debfb2b97411a4fea">data</a>,data_body-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a>);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>                <span class="keywordflow">if</span> (data_body-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a> &gt; 0)</div>
<div class="line">                      bio = <a class="code" href="bio_8h.html#a3c93aa21db46e50b7002f434b641d218">BIO_new_mem_buf</a>(data_body-&gt;<a class="code" href="structasn1__string__st.html#a275a9784693f470debfb2b97411a4fea">data</a>,data_body-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a>);</div>
<div class="line">                <span class="keywordflow">else</span> {</div>
<div class="line">                        bio=<a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio_8h.html#aa00c1ff95f6d83e358d2daa6eca3e724">BIO_s_mem</a>());</div>
<div class="line">                        <a class="code" href="bio_8h.html#a11c737cf2f36d5a7f681590b6c0a2cc3">BIO_set_mem_eof_return</a>(bio,0);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (bio == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>                }</div>
<div class="line">        <a class="code" href="bio_8h.html#a4e509280cddd4eb3537fe7e3bc0827a9">BIO_push</a>(out,bio);</div>
<div class="line">        bio=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (0)</div>
<div class="line">                {</div>
<div class="line">err:</div>
<div class="line">               <span class="keywordflow">if</span> (ek)</div>
<div class="line">                       {</div>
<div class="line">                       <a class="code" href="crypto_8h.html#a2aa47e40c63b05d00e9a780592f2a2b8">OPENSSL_cleanse</a>(ek,eklen);</div>
<div class="line">                       <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(ek);</div>
<div class="line">                       }</div>
<div class="line">               <span class="keywordflow">if</span> (tkey)</div>
<div class="line">                       {</div>
<div class="line">                       <a class="code" href="crypto_8h.html#a2aa47e40c63b05d00e9a780592f2a2b8">OPENSSL_cleanse</a>(tkey,tkeylen);</div>
<div class="line">                       <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(tkey);</div>
<div class="line">                       }</div>
<div class="line">                <span class="keywordflow">if</span> (out != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>) <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(out);</div>
<div class="line">                <span class="keywordflow">if</span> (btmp != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>) <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(btmp);</div>
<div class="line">                <span class="keywordflow">if</span> (etmp != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>) <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(etmp);</div>
<div class="line">                <span class="keywordflow">if</span> (bio != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>) <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(bio);</div>
<div class="line">                out=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">return</span>(out);</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="adda922d753824551b5c081373ccbd8a5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_dataFinal </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>bio</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l00739">739</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordtype">int</span> ret=0;</div>
<div class="line">        <span class="keywordtype">int</span> i,j;</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *btmp;</div>
<div class="line">        <a class="code" href="structpkcs7__signer__info__st.html">PKCS7_SIGNER_INFO</a> *si;</div>
<div class="line">        <a class="code" href="structenv__md__ctx__st.html">EVP_MD_CTX</a> *mdc,ctx_tmp;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structx509__attributes__st.html">X509_ATTRIBUTE</a>) *sk;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structpkcs7__signer__info__st.html">PKCS7_SIGNER_INFO</a>) *si_sk=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structasn1__string__st.html">ASN1_OCTET_STRING</a> *os=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="digest_8c.html#afe58145aa88a8ee187d858c762c00399">EVP_MD_CTX_init</a>(&amp;ctx_tmp);</div>
<div class="line">        i=<a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#acd92bf461725525e7785077578ccf226">type</a>);</div>
<div class="line">        p7-&gt;<a class="code" href="structpkcs7__st.html#a347c4591ec3bcf75f4dd86b430b20426">state</a>=<a class="code" href="pkcs7_8h.html#a887df905e3120a68183bc75ceaa86d70">PKCS7_S_HEADER</a>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (i)</div>
<div class="line">                {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a13d08edbaf91c1fd310b3e4cbd9f98a9">NID_pkcs7_data</a>:</div>
<div class="line">                os = p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#aa85034648deabb1e0f6edeaa2d75ee50">data</a>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a320f30f595981af7aa071c54922a7f03">NID_pkcs7_signedAndEnveloped</a>:</div>
<div class="line">                <span class="comment">/* XXXXXXXXXXXXXXXX */</span></div>
<div class="line">                si_sk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;signer_info;</div>
<div class="line">                os = p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;<a class="code" href="structpkcs7__signedandenveloped__st.html#a13b7235eaaab4212ab646d69c10c8012">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#ab4d08c0f1b94885ea0d0380ef4745c7b">enc_data</a>;</div>
<div class="line">                <span class="keywordflow">if</span> (!os)</div>
<div class="line">                        {</div>
<div class="line">                        os=<a class="code" href="asn1_8h.html#a5470e63f2455b7949cbae70a7857a9a4">M_ASN1_OCTET_STRING_new</a>();</div>
<div class="line">                        <span class="keywordflow">if</span> (!os)</div>
<div class="line">                                {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a64f2b56c482865477c563e5bf4acb3db">PKCS7_F_PKCS7_DATAFINAL</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                                }</div>
<div class="line">                        p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;<a class="code" href="structpkcs7__signedandenveloped__st.html#a13b7235eaaab4212ab646d69c10c8012">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#ab4d08c0f1b94885ea0d0380ef4745c7b">enc_data</a>=os;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a4587e848643383571699c4b1fdaf5710">NID_pkcs7_enveloped</a>:</div>
<div class="line">                <span class="comment">/* XXXXXXXXXXXXXXXX */</span></div>
<div class="line">                os = p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;<a class="code" href="structpkcs7__enveloped__st.html#a70fb3ace75518cf782f9e0330f4a140e">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#ab4d08c0f1b94885ea0d0380ef4745c7b">enc_data</a>;</div>
<div class="line">                <span class="keywordflow">if</span> (!os)</div>
<div class="line">                        {</div>
<div class="line">                        os=<a class="code" href="asn1_8h.html#a5470e63f2455b7949cbae70a7857a9a4">M_ASN1_OCTET_STRING_new</a>();</div>
<div class="line">                        <span class="keywordflow">if</span> (!os)</div>
<div class="line">                                {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a64f2b56c482865477c563e5bf4acb3db">PKCS7_F_PKCS7_DATAFINAL</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                                }</div>
<div class="line">                        p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;<a class="code" href="structpkcs7__enveloped__st.html#a70fb3ace75518cf782f9e0330f4a140e">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#ab4d08c0f1b94885ea0d0380ef4745c7b">enc_data</a>=os;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a085f07bc1100332366a5675145f8fea9">NID_pkcs7_signed</a>:</div>
<div class="line">                si_sk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;signer_info;</div>
<div class="line">                os=PKCS7_get_octet_string(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;<a class="code" href="structpkcs7__signed__st.html#a41182027c38487c5be24e8609f4590f8">contents</a>);</div>
<div class="line">                <span class="comment">/* If detached data then the content is excluded */</span></div>
<div class="line">                <span class="keywordflow">if</span>(<a class="code" href="pkcs7_8h.html#a7a40c56f81f8be7ef48b24f656b11599">PKCS7_type_is_data</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;<a class="code" href="structpkcs7__signed__st.html#a41182027c38487c5be24e8609f4590f8">contents</a>) &amp;&amp; p7-&gt;<a class="code" href="structpkcs7__st.html#aaefed5b8e3dc5995f7fb1e1a300b7668">detached</a>) {</div>
<div class="line">                        <a class="code" href="asn1_8h.html#aeb277ca2a74c79c8794658522833c176">M_ASN1_OCTET_STRING_free</a>(os);</div>
<div class="line">                        p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;<a class="code" href="structpkcs7__signed__st.html#a41182027c38487c5be24e8609f4590f8">contents</a>-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#aa85034648deabb1e0f6edeaa2d75ee50">data</a> = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a5913b3f520c08ebb4000fee1be9ec0f5">NID_pkcs7_digest</a>:</div>
<div class="line">                os=PKCS7_get_octet_string(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a1c5d480705bdf17b4632d8ef2031a46d">digest</a>-&gt;<a class="code" href="structpkcs7__digest__st.html#ac519ce261ee599eaacd0ac4f2f06ebe7">contents</a>);</div>
<div class="line">                <span class="comment">/* If detached data then the content is excluded */</span></div>
<div class="line">                <span class="keywordflow">if</span>(<a class="code" href="pkcs7_8h.html#a7a40c56f81f8be7ef48b24f656b11599">PKCS7_type_is_data</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a1c5d480705bdf17b4632d8ef2031a46d">digest</a>-&gt;<a class="code" href="structpkcs7__digest__st.html#ac519ce261ee599eaacd0ac4f2f06ebe7">contents</a>) &amp;&amp; p7-&gt;<a class="code" href="structpkcs7__st.html#aaefed5b8e3dc5995f7fb1e1a300b7668">detached</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="asn1_8h.html#aeb277ca2a74c79c8794658522833c176">M_ASN1_OCTET_STRING_free</a>(os);</div>
<div class="line">                        p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a1c5d480705bdf17b4632d8ef2031a46d">digest</a>-&gt;<a class="code" href="structpkcs7__digest__st.html#ac519ce261ee599eaacd0ac4f2f06ebe7">contents</a>-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#aa85034648deabb1e0f6edeaa2d75ee50">data</a> = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a64f2b56c482865477c563e5bf4acb3db">PKCS7_F_PKCS7_DATAFINAL</a>,<a class="code" href="pkcs7_8h.html#a852a7427b8e37e3d1fbddc4497ec275d">PKCS7_R_UNSUPPORTED_CONTENT_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (si_sk != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#ab2bc3323ef185811a28d36add6396d4e">sk_PKCS7_SIGNER_INFO_num</a>(si_sk); i++)</div>
<div class="line">                        {</div>
<div class="line">                        si=<a class="code" href="safestack_8h.html#a8d361c2354282f7e437265f09fef7a96">sk_PKCS7_SIGNER_INFO_value</a>(si_sk,i);</div>
<div class="line">                        <span class="keywordflow">if</span> (si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#acac9c5af6fa0f01bb42fe39c8f2f646a">pkey</a> == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">                        j = <a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#a238fa797ab7db21717ae5b4d68a925ef">digest_alg</a>-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a>);</div>
<div class="line"></div>
<div class="line">                        btmp=bio;</div>
<div class="line"></div>
<div class="line">                        btmp = PKCS7_find_digest(&amp;mdc, btmp, j);</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">if</span> (btmp == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">                        <span class="comment">/* We now have the EVP_MD_CTX, lets do the</span></div>
<div class="line"><span class="comment">                         * signing. */</span></div>
<div class="line">                        <span class="keywordflow">if</span> (!<a class="code" href="digest_8c.html#ab42e7b7bc6ec24356f278a660fcc61f0">EVP_MD_CTX_copy_ex</a>(&amp;ctx_tmp,mdc))</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">                        sk=si-&gt;auth_attr;</div>
<div class="line"></div>
<div class="line">                        <span class="comment">/* If there are attributes, we add the digest</span></div>
<div class="line"><span class="comment">                         * attribute and only sign the attributes */</span></div>
<div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="safestack_8h.html#a8d6491802d2d89d131cf226e843a4475">sk_X509_ATTRIBUTE_num</a>(sk) &gt; 0)</div>
<div class="line">                                {</div>
<div class="line">                                <span class="keywordflow">if</span> (!do_pkcs7_signed_attrib(si, &amp;ctx_tmp))</div>
<div class="line">                                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                                }</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                                {</div>
<div class="line">                                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *abuf = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> abuflen;</div>
<div class="line">                                abuflen = <a class="code" href="evp_8h.html#a091bd35ff66b3254a028501991262f21">EVP_PKEY_size</a>(si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#acac9c5af6fa0f01bb42fe39c8f2f646a">pkey</a>);</div>
<div class="line">                                abuf = <a class="code" href="crypto_8h.html#afdb80d14aed3b15d0ef71f72a872310d">OPENSSL_malloc</a>(abuflen);</div>
<div class="line">                                <span class="keywordflow">if</span> (!abuf)</div>
<div class="line">                                        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">                                <span class="keywordflow">if</span> (!<a class="code" href="evp_8h.html#a2bbb088965b25d0e31bb52c8260f3d76">EVP_SignFinal</a>(&amp;ctx_tmp, abuf, &amp;abuflen,</div>
<div class="line">                                                        si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#acac9c5af6fa0f01bb42fe39c8f2f646a">pkey</a>))</div>
<div class="line">                                        {</div>
<div class="line">                                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a64f2b56c482865477c563e5bf4acb3db">PKCS7_F_PKCS7_DATAFINAL</a>,</div>
<div class="line">                                                        <a class="code" href="err_8h.html#a8959418b04c171c02dbacbd298326e2f">ERR_R_EVP_LIB</a>);</div>
<div class="line">                                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                                        }</div>
<div class="line">                                <a class="code" href="asn1_8h.html#add085933f3a303f7c59acf0e9b072d63">ASN1_STRING_set0</a>(si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#a75a871ba0bdc83cbd05822e844badf40">enc_digest</a>, abuf, abuflen);</div>
<div class="line">                                }</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == <a class="code" href="obj__mac_8h.html#a5913b3f520c08ebb4000fee1be9ec0f5">NID_pkcs7_digest</a>)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> md_data[<a class="code" href="evp_8h.html#a71bfc78a168f00f0c4ffd2535082b129">EVP_MAX_MD_SIZE</a>];</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> md_len;</div>
<div class="line">                <span class="keywordflow">if</span> (!PKCS7_find_digest(&amp;mdc, bio,</div>
<div class="line">                                <a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a1c5d480705bdf17b4632d8ef2031a46d">digest</a>-&gt;<a class="code" href="structpkcs7__digest__st.html#a76481d96de4d0f8457fe75c6d29131e6">md</a>-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a>)))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="keywordflow">if</span> (!<a class="code" href="digest_8c.html#a3c3bec018dd4bdf73a3f14d27ea9b718">EVP_DigestFinal_ex</a>(mdc,md_data,&amp;md_len))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <a class="code" href="asn1_8h.html#aee8c15d7dcb309dc19824b7eee3678bd">M_ASN1_OCTET_STRING_set</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a1c5d480705bdf17b4632d8ef2031a46d">digest</a>-&gt;<a class="code" href="structpkcs7__digest__st.html#ad75a037194fd4d99c1a5aa180a8e96e8">digest</a>, md_data, md_len);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="pkcs7_8h.html#a9e179c864c647a38e504334fac8cc875">PKCS7_is_detached</a>(p7) &amp;&amp; !(os-&gt;<a class="code" href="structasn1__string__st.html#a166fa78d828cb41bb2499ad411c1774c">flags</a> &amp; <a class="code" href="asn1_8h.html#acfd3d2e84baac0730e8c99d260a7fba9">ASN1_STRING_FLAG_NDEF</a>))</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordtype">char</span> *cont;</div>
<div class="line">                <span class="keywordtype">long</span> contlen;</div>
<div class="line">                btmp=<a class="code" href="bio_8h.html#aee7bbe95cd69d7944f939d4a8073604c">BIO_find_type</a>(bio,<a class="code" href="bio_8h.html#a85fbb99a752fe49d342b1685580587b7">BIO_TYPE_MEM</a>);</div>
<div class="line">                <span class="keywordflow">if</span> (btmp == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a64f2b56c482865477c563e5bf4acb3db">PKCS7_F_PKCS7_DATAFINAL</a>,<a class="code" href="pkcs7_8h.html#ae80be74e3d4c1dc4f73cc7d78dfb0a44">PKCS7_R_UNABLE_TO_FIND_MEM_BIO</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                contlen = <a class="code" href="bio_8h.html#ad1cca133aa21da42cf8dac755e0b4df1">BIO_get_mem_data</a>(btmp, &amp;cont);</div>
<div class="line">                <span class="comment">/* Mark the BIO read only then we can use its copy of the data</span></div>
<div class="line"><span class="comment">                 * instead of making an extra copy.</span></div>
<div class="line"><span class="comment">                 */</span></div>
<div class="line">                <a class="code" href="bio_8h.html#ae23cacabf82f08ca0aaf4610cdefb6d0">BIO_set_flags</a>(btmp, <a class="code" href="bio_8h.html#a24787480b006c3280e3e406c7f1a74fc">BIO_FLAGS_MEM_RDONLY</a>);</div>
<div class="line">                <a class="code" href="bio_8h.html#a11c737cf2f36d5a7f681590b6c0a2cc3">BIO_set_mem_eof_return</a>(btmp, 0);</div>
<div class="line">                <a class="code" href="asn1_8h.html#add085933f3a303f7c59acf0e9b072d63">ASN1_STRING_set0</a>(os, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)cont, contlen);</div>
<div class="line">                }</div>
<div class="line">        ret=1;</div>
<div class="line">err:</div>
<div class="line">        <a class="code" href="digest_8c.html#ac6c8c38d6c8e3e274c9a974792b8342d">EVP_MD_CTX_cleanup</a>(&amp;ctx_tmp);</div>
<div class="line">        <span class="keywordflow">return</span>(ret);</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a0fb23f12a84dea91d6d0c2e9fd202e71"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a>* PKCS7_dataInit </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>bio</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l00263">263</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordtype">int</span> i;</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *<a class="code" href="ideatest_8c.html#afdf65de9e264331943a9e5a248271311">out</a>=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>,*btmp=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structX509__algor__st.html">X509_ALGOR</a> *xa = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="structevp__cipher__st.html">EVP_CIPHER</a> *evp_cipher=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structX509__algor__st.html">X509_ALGOR</a>) *md_sk=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structpkcs7__recip__info__st.html">PKCS7_RECIP_INFO</a>) *rsk=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structX509__algor__st.html">X509_ALGOR</a> *xalg=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structpkcs7__recip__info__st.html">PKCS7_RECIP_INFO</a> *ri=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="structasn1__string__st.html">ASN1_OCTET_STRING</a> *os=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line"></div>
<div class="line">        i=<a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#acd92bf461725525e7785077578ccf226">type</a>);</div>
<div class="line">        p7-&gt;<a class="code" href="structpkcs7__st.html#a347c4591ec3bcf75f4dd86b430b20426">state</a>=<a class="code" href="pkcs7_8h.html#a887df905e3120a68183bc75ceaa86d70">PKCS7_S_HEADER</a>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (i)</div>
<div class="line">                {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a085f07bc1100332366a5675145f8fea9">NID_pkcs7_signed</a>:</div>
<div class="line">                md_sk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;md_algs;</div>
<div class="line">                os = PKCS7_get_octet_string(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;<a class="code" href="structpkcs7__signed__st.html#a41182027c38487c5be24e8609f4590f8">contents</a>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a320f30f595981af7aa071c54922a7f03">NID_pkcs7_signedAndEnveloped</a>:</div>
<div class="line">                rsk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;recipientinfo;</div>
<div class="line">                md_sk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;md_algs;</div>
<div class="line">                xalg=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;<a class="code" href="structpkcs7__signedandenveloped__st.html#a13b7235eaaab4212ab646d69c10c8012">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#af6c78a84b4ca86334dfc04a072ce1117">algorithm</a>;</div>
<div class="line">                evp_cipher=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;<a class="code" href="structpkcs7__signedandenveloped__st.html#a13b7235eaaab4212ab646d69c10c8012">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#abb4444669fdf67803367ebddf34b8aff">cipher</a>;</div>
<div class="line">                <span class="keywordflow">if</span> (evp_cipher == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a7c890d38a0de8eee823074d659ad62cc">PKCS7_F_PKCS7_DATAINIT</a>,</div>
<div class="line">                                                <a class="code" href="pkcs7_8h.html#aba4b6f3538f362aac0b33b6d366c960c">PKCS7_R_CIPHER_NOT_INITIALIZED</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a4587e848643383571699c4b1fdaf5710">NID_pkcs7_enveloped</a>:</div>
<div class="line">                rsk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;recipientinfo;</div>
<div class="line">                xalg=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;<a class="code" href="structpkcs7__enveloped__st.html#a70fb3ace75518cf782f9e0330f4a140e">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#af6c78a84b4ca86334dfc04a072ce1117">algorithm</a>;</div>
<div class="line">                evp_cipher=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a05449438507cd8c8b8692839bbbfb9c3">enveloped</a>-&gt;<a class="code" href="structpkcs7__enveloped__st.html#a70fb3ace75518cf782f9e0330f4a140e">enc_data</a>-&gt;<a class="code" href="structpkcs7__enc__content__st.html#abb4444669fdf67803367ebddf34b8aff">cipher</a>;</div>
<div class="line">                <span class="keywordflow">if</span> (evp_cipher == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a7c890d38a0de8eee823074d659ad62cc">PKCS7_F_PKCS7_DATAINIT</a>,</div>
<div class="line">                                                <a class="code" href="pkcs7_8h.html#aba4b6f3538f362aac0b33b6d366c960c">PKCS7_R_CIPHER_NOT_INITIALIZED</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a5913b3f520c08ebb4000fee1be9ec0f5">NID_pkcs7_digest</a>:</div>
<div class="line">                xa = p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a1c5d480705bdf17b4632d8ef2031a46d">digest</a>-&gt;<a class="code" href="structpkcs7__digest__st.html#a76481d96de4d0f8457fe75c6d29131e6">md</a>;</div>
<div class="line">                os = PKCS7_get_octet_string(p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#a1c5d480705bdf17b4632d8ef2031a46d">digest</a>-&gt;<a class="code" href="structpkcs7__digest__st.html#ac519ce261ee599eaacd0ac4f2f06ebe7">contents</a>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="obj__mac_8h.html#a13d08edbaf91c1fd310b3e4cbd9f98a9">NID_pkcs7_data</a>:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a7c890d38a0de8eee823074d659ad62cc">PKCS7_F_PKCS7_DATAINIT</a>,<a class="code" href="pkcs7_8h.html#a852a7427b8e37e3d1fbddc4497ec275d">PKCS7_R_UNSUPPORTED_CONTENT_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#a94c75bbf81b8ad2a5ae09b10c8e47719">sk_X509_ALGOR_num</a>(md_sk); i++)</div>
<div class="line">                <span class="keywordflow">if</span> (!PKCS7_bio_add_digest(&amp;out, <a class="code" href="safestack_8h.html#a6f0738d8fab06b164ea825826b366fd0">sk_X509_ALGOR_value</a>(md_sk, i)))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (xa &amp;&amp; !PKCS7_bio_add_digest(&amp;out, xa))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (evp_cipher != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="des_8c.html#a6a4ff80275090619f35902b61a8c6bf6">key</a>[<a class="code" href="evp_8h.html#a9646a5fcb0387590176a8bdf6d529685">EVP_MAX_KEY_LENGTH</a>];</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> iv[<a class="code" href="evp_8h.html#a80893bc2dbae769441bf6a042cf4069e">EVP_MAX_IV_LENGTH</a>];</div>
<div class="line">                <span class="keywordtype">int</span> keylen,ivlen;</div>
<div class="line">                <a class="code" href="structevp__cipher__ctx__st.html">EVP_CIPHER_CTX</a> *ctx;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> ((btmp=<a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio__enc_8c.html#ae38a2c0160131c560c98fbf63d1eb65d">BIO_f_cipher</a>())) == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a7c890d38a0de8eee823074d659ad62cc">PKCS7_F_PKCS7_DATAINIT</a>,<a class="code" href="err_8h.html#a1a872529560db1107b62b62c935e6c7d">ERR_R_BIO_LIB</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <a class="code" href="evp_8h.html#a04d02269f6bd11231243c65acce8f57e">BIO_get_cipher_ctx</a>(btmp, &amp;ctx);</div>
<div class="line">                keylen=<a class="code" href="evp_8h.html#a71547eee68dcde07ec8befd0659d2b33">EVP_CIPHER_key_length</a>(evp_cipher);</div>
<div class="line">                ivlen=<a class="code" href="evp_8h.html#aa144b5155108548ceddbfd87f24f5236">EVP_CIPHER_iv_length</a>(evp_cipher);</div>
<div class="line">                xalg-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a> = <a class="code" href="obj__dat_8c.html#a42d9bf0fd7cd17fe4101c74c215b37ca">OBJ_nid2obj</a>(<a class="code" href="evp_8h.html#aa1c4358ddebcc50cb551d1b4ac1f1f64">EVP_CIPHER_type</a>(evp_cipher));</div>
<div class="line">                <span class="keywordflow">if</span> (ivlen &gt; 0)</div>
<div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="rand_8h.html#a8a4e911a9be281eb797faa8590637ac3">RAND_pseudo_bytes</a>(iv,ivlen) &lt;= 0)</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#aab11ae066491958c229882a364c3feb8">EVP_CipherInit_ex</a>(ctx, evp_cipher, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, 1)&lt;=0)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#a2f171ee3d2e29079c553d8cfafeaadaf">EVP_CIPHER_CTX_rand_key</a>(ctx, key) &lt;= 0)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#aab11ae066491958c229882a364c3feb8">EVP_CipherInit_ex</a>(ctx, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, key, iv, 1) &lt;= 0)</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (ivlen &gt; 0) {</div>
<div class="line">                        <span class="keywordflow">if</span> (xalg-&gt;<a class="code" href="structX509__algor__st.html#a0c0f294d859665c5b1e6d86c695ac4e1">parameter</a> == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>) {</div>
<div class="line">                                xalg-&gt;<a class="code" href="structX509__algor__st.html#a0c0f294d859665c5b1e6d86c695ac4e1">parameter</a> = ASN1_TYPE_new();</div>
<div class="line">                                <span class="keywordflow">if</span> (xalg-&gt;<a class="code" href="structX509__algor__st.html#a0c0f294d859665c5b1e6d86c695ac4e1">parameter</a> == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="evp_8h.html#a3a3e94ce6ad87d960addd62106a6d71d">EVP_CIPHER_param_to_asn1</a>(ctx, xalg-&gt;<a class="code" href="structX509__algor__st.html#a0c0f294d859665c5b1e6d86c695ac4e1">parameter</a>) &lt; 0)</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">/* Lets do the pub key stuff :-) */</span></div>
<div class="line">                <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#aaf938089edc5c86b468001186bfacbc8">sk_PKCS7_RECIP_INFO_num</a>(rsk); i++)</div>
<div class="line">                        {</div>
<div class="line">                        ri=<a class="code" href="safestack_8h.html#adc3552a5f950bb1f68425ac1042f7d7c">sk_PKCS7_RECIP_INFO_value</a>(rsk,i);</div>
<div class="line">                        <span class="keywordflow">if</span> (pkcs7_encode_rinfo(ri, key, keylen) &lt;= 0)</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <a class="code" href="crypto_8h.html#a2aa47e40c63b05d00e9a780592f2a2b8">OPENSSL_cleanse</a>(key, keylen);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (out == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        out=btmp;</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                        <a class="code" href="bio_8h.html#a4e509280cddd4eb3537fe7e3bc0827a9">BIO_push</a>(out,btmp);</div>
<div class="line">                btmp=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (bio == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#a9e179c864c647a38e504334fac8cc875">PKCS7_is_detached</a>(p7))</div>
<div class="line">                        bio=<a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio_8h.html#af30879ddb464dd84bbd801075291d058">BIO_s_null</a>());</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (os &amp;&amp; os-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a> &gt; 0)</div>
<div class="line">                        bio = <a class="code" href="bio_8h.html#a3c93aa21db46e50b7002f434b641d218">BIO_new_mem_buf</a>(os-&gt;<a class="code" href="structasn1__string__st.html#a275a9784693f470debfb2b97411a4fea">data</a>, os-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a>);</div>
<div class="line">                <span class="keywordflow">if</span>(bio == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        bio=<a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio_8h.html#aa00c1ff95f6d83e358d2daa6eca3e724">BIO_s_mem</a>());</div>
<div class="line">                        <span class="keywordflow">if</span> (bio == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                        <a class="code" href="bio_8h.html#a11c737cf2f36d5a7f681590b6c0a2cc3">BIO_set_mem_eof_return</a>(bio,0);</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">if</span> (out)</div>
<div class="line">                <a class="code" href="bio_8h.html#a4e509280cddd4eb3537fe7e3bc0827a9">BIO_push</a>(out,bio);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">                out = bio;</div>
<div class="line">        bio=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keywordflow">if</span> (0)</div>
<div class="line">                {</div>
<div class="line">err:</div>
<div class="line">                <span class="keywordflow">if</span> (out != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(out);</div>
<div class="line">                <span class="keywordflow">if</span> (btmp != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(btmp);</div>
<div class="line">                out=<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">return</span>(out);</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ae20129e7b71aa1757f4d26a3068b4e80"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_dataVerify </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a3a2b800bae08729d11bc28f12b795597">X509_STORE</a> *&#160;</td>
          <td class="paramname"><em>cert_store</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#ae681945a2cf88d6337137dc0260a1545">X509_STORE_CTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>bio</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>si</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l00960">960</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <a class="code" href="structpkcs7__issuer__and__serial__st.html">PKCS7_ISSUER_AND_SERIAL</a> *ias;</div>
<div class="line">        <span class="keywordtype">int</span> ret=0,i;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structx509__st.html">X509</a>) *cert;</div>
<div class="line">        <a class="code" href="structx509__st.html">X509</a> *x509;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#a0e36637a90f6275e095126838245f911">PKCS7_type_is_signed</a>(p7))</div>
<div class="line">                {</div>
<div class="line">                cert=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;cert;</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#af803f5bbc7af07417d3d5b4c99ccba1a">PKCS7_type_is_signedAndEnveloped</a>(p7))</div>
<div class="line">                {</div>
<div class="line">                cert=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;cert;</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a2444b2a609983b4da23ddb253b604ff3">PKCS7_F_PKCS7_DATAVERIFY</a>,<a class="code" href="pkcs7_8h.html#a368001153d8b6c97c8f120bac53b756d">PKCS7_R_WRONG_PKCS7_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">        <span class="comment">/* XXXXXXXXXXXXXXXXXXXXXXX */</span></div>
<div class="line">        ias=si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#aa50f5aaf37775fa181c551407b620d6c">issuer_and_serial</a>;</div>
<div class="line"></div>
<div class="line">        x509=<a class="code" href="x509_8h.html#af12e92c74d1b8d870bc9082d164efd36">X509_find_by_issuer_and_serial</a>(cert,ias-&gt;<a class="code" href="structpkcs7__issuer__and__serial__st.html#ace9f7a526b2d91328ce37a1b3d26c179">issuer</a>,ias-&gt;<a class="code" href="structpkcs7__issuer__and__serial__st.html#a46903221f3f9a3a0243bbaae23afbe98">serial</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* were we able to find the cert in passed to us */</span></div>
<div class="line">        <span class="keywordflow">if</span> (x509 == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a2444b2a609983b4da23ddb253b604ff3">PKCS7_F_PKCS7_DATAVERIFY</a>,<a class="code" href="pkcs7_8h.html#a986fc069502d79638703769ad386fa3e">PKCS7_R_UNABLE_TO_FIND_CERTIFICATE</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Lets verify */</span></div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="x509__vfy_8c.html#a513e70fc82c927254c38d0ac102bafd9">X509_STORE_CTX_init</a>(ctx,cert_store,x509,cert))</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a2444b2a609983b4da23ddb253b604ff3">PKCS7_F_PKCS7_DATAVERIFY</a>,<a class="code" href="err_8h.html#a73974afeda3d4c0c803b60969682a13a">ERR_R_X509_LIB</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">        <a class="code" href="x509__vfy_8c.html#a2b4939baca9b28b912b54841865b492b">X509_STORE_CTX_set_purpose</a>(ctx, <a class="code" href="x509v3_8h.html#a4ec56f8532bb76fa95438a2ed3c7bf2a">X509_PURPOSE_SMIME_SIGN</a>);</div>
<div class="line">        i=<a class="code" href="x509_8h.html#a00794722daae3cb1e10ec00eda7c2c62">X509_verify_cert</a>(ctx);</div>
<div class="line">        <span class="keywordflow">if</span> (i &lt;= 0) </div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a2444b2a609983b4da23ddb253b604ff3">PKCS7_F_PKCS7_DATAVERIFY</a>,<a class="code" href="err_8h.html#a73974afeda3d4c0c803b60969682a13a">ERR_R_X509_LIB</a>);</div>
<div class="line">                <a class="code" href="x509__vfy_8c.html#a8ff79593c52dcc4c9e63bfb7146bb9e3">X509_STORE_CTX_cleanup</a>(ctx);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">        <a class="code" href="x509__vfy_8c.html#a8ff79593c52dcc4c9e63bfb7146bb9e3">X509_STORE_CTX_cleanup</a>(ctx);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="pk7__doit_8c.html#a43129e7012c9aba2b945584972810198">PKCS7_signatureVerify</a>(bio, p7, si, x509);</div>
<div class="line">        err:</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="abf8691133031089e545fe535e3b79e15"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="ossl__typ_8h.html#afbd05e94e0f0430a2b729473efec88c1">ASN1_OCTET_STRING</a>* PKCS7_digest_from_attributes </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="x509_8h.html#aa4f1a62a9d2dd8cb6780fe2713737c0f">X509_ATTRIBUTE</a>)*&#160;</td>
          <td class="paramname"><em>sk</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01195">1195</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <a class="code" href="structasn1__type__st.html">ASN1_TYPE</a> *astype;</div>
<div class="line">        <span class="keywordflow">if</span>(!(astype = get_attribute(sk, <a class="code" href="obj__mac_8h.html#aeaaf631dea9b53302214ef2d461cfc40">NID_pkcs9_messageDigest</a>))) <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keywordflow">return</span> astype-&gt;<a class="code" href="structasn1__type__st.html#ab37a86242c23b20bd17ee2adb4678e38">value</a>.<a class="code" href="structasn1__type__st.html#a57c398f62f5af3ca6a9130b651d7bca6">octet_string</a>;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a63a85c504c51f36bbb8c5d29916cc3fd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="asn1_8h.html#a7895e03d9fee2bc4963faf2a31a9439e">ASN1_TYPE</a>* PKCS7_get_attribute </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>si</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>nid</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01168">1168</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordflow">return</span>(get_attribute(si-&gt;unauth_attr,<a class="code" href="pem_8h.html#a85baed467a8a5107268fae0ceb6cb9b6">nid</a>));</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a4d1b1b17269f8a25c410711d6f1cb181"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="pkcs7_8h.html#a3f5400dcd95708494b81eaae75743fcf">PKCS7_ISSUER_AND_SERIAL</a>* PKCS7_get_issuer_and_serial </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>idx</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01143">1143</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structpkcs7__recip__info__st.html">PKCS7_RECIP_INFO</a>) *rsk;</div>
<div class="line">        <a class="code" href="structpkcs7__recip__info__st.html">PKCS7_RECIP_INFO</a> *ri;</div>
<div class="line">        <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">        i=<a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(p7-&gt;<a class="code" href="structpkcs7__st.html#acd92bf461725525e7785077578ccf226">type</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (i != <a class="code" href="obj__mac_8h.html#a320f30f595981af7aa071c54922a7f03">NID_pkcs7_signedAndEnveloped</a>)</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keywordflow">if</span> (p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a> == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        rsk=p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#afe69a67d002aad9fc12be3a3bc019551">signed_and_enveloped</a>-&gt;recipientinfo;</div>
<div class="line">        <span class="keywordflow">if</span> (rsk == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        ri=<a class="code" href="safestack_8h.html#adc3552a5f950bb1f68425ac1042f7d7c">sk_PKCS7_RECIP_INFO_value</a>(rsk,0);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="safestack_8h.html#aaf938089edc5c86b468001186bfacbc8">sk_PKCS7_RECIP_INFO_num</a>(rsk) &lt;= idx) <span class="keywordflow">return</span>(<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>);</div>
<div class="line">        ri=<a class="code" href="safestack_8h.html#adc3552a5f950bb1f68425ac1042f7d7c">sk_PKCS7_RECIP_INFO_value</a>(rsk,idx);</div>
<div class="line">        <span class="keywordflow">return</span>(ri-&gt;<a class="code" href="structpkcs7__recip__info__st.html#a518df74b0610022385c23e30d659c003">issuer_and_serial</a>);</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a648d6d429b4ff13f3a1250890d4ce7ff"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="asn1_8h.html#a7895e03d9fee2bc4963faf2a31a9439e">ASN1_TYPE</a>* PKCS7_get_signed_attribute </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>si</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>nid</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01163">1163</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordflow">return</span>(get_attribute(si-&gt;auth_attr,<a class="code" href="pem_8h.html#a85baed467a8a5107268fae0ceb6cb9b6">nid</a>));</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ae1b3b3bc41a641cdceddd40df2c326b8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_set_attributes </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>p7si</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="x509_8h.html#aa4f1a62a9d2dd8cb6780fe2713737c0f">X509_ATTRIBUTE</a>)*&#160;</td>
          <td class="paramname"><em>sk</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01222">1222</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (p7si-&gt;unauth_attr != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                <a class="code" href="safestack_8h.html#a88edeeceb68a2231784296a915f3d8ab">sk_X509_ATTRIBUTE_pop_free</a>(p7si-&gt;unauth_attr,</div>
<div class="line">                                           X509_ATTRIBUTE_free);</div>
<div class="line">        p7si-&gt;unauth_attr=<a class="code" href="safestack_8h.html#a7b9b5b9ee2e36d7aba39d145eedc25fe">sk_X509_ATTRIBUTE_dup</a>(sk);</div>
<div class="line">        <span class="keywordflow">if</span> (p7si-&gt;unauth_attr == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#a8d6491802d2d89d131cf226e843a4475">sk_X509_ATTRIBUTE_num</a>(sk); i++)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">if</span> ((<a class="code" href="safestack_8h.html#a3e50a1b87e124b58006e2f1144347904">sk_X509_ATTRIBUTE_set</a>(p7si-&gt;unauth_attr,i,</div>
<div class="line">                        <a class="code" href="x509_8h.html#a0b795d15ae60484c806238dea5ce6ec6">X509_ATTRIBUTE_dup</a>(<a class="code" href="safestack_8h.html#a27ba56c5d3b84a84417db117cfad5267">sk_X509_ATTRIBUTE_value</a>(sk,i))))</div>
<div class="line">                    == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        <span class="keywordflow">return</span>(0);</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">return</span>(1);</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="aa5da0604e0ffb4c32e7a6a50cba84cd3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_set_signed_attributes </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>p7si</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="x509_8h.html#aa4f1a62a9d2dd8cb6780fe2713737c0f">X509_ATTRIBUTE</a>)*&#160;</td>
          <td class="paramname"><em>sk</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01202">1202</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (p7si-&gt;auth_attr != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                <a class="code" href="safestack_8h.html#a88edeeceb68a2231784296a915f3d8ab">sk_X509_ATTRIBUTE_pop_free</a>(p7si-&gt;auth_attr,X509_ATTRIBUTE_free);</div>
<div class="line">        p7si-&gt;auth_attr=<a class="code" href="safestack_8h.html#a7b9b5b9ee2e36d7aba39d145eedc25fe">sk_X509_ATTRIBUTE_dup</a>(sk);</div>
<div class="line">        <span class="keywordflow">if</span> (p7si-&gt;auth_attr == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#a8d6491802d2d89d131cf226e843a4475">sk_X509_ATTRIBUTE_num</a>(sk); i++)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">if</span> ((<a class="code" href="safestack_8h.html#a3e50a1b87e124b58006e2f1144347904">sk_X509_ATTRIBUTE_set</a>(p7si-&gt;auth_attr,i,</div>
<div class="line">                        <a class="code" href="x509_8h.html#a0b795d15ae60484c806238dea5ce6ec6">X509_ATTRIBUTE_dup</a>(<a class="code" href="safestack_8h.html#a27ba56c5d3b84a84417db117cfad5267">sk_X509_ATTRIBUTE_value</a>(sk,i))))</div>
<div class="line">                    == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        <span class="keywordflow">return</span>(0);</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">return</span>(1);</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a43129e7012c9aba2b945584972810198"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_signatureVerify </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>bio</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>si</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *&#160;</td>
          <td class="paramname"><em>x509</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l01014">1014</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <a class="code" href="structasn1__string__st.html">ASN1_OCTET_STRING</a> *os;</div>
<div class="line">        <a class="code" href="structenv__md__ctx__st.html">EVP_MD_CTX</a> mdc_tmp,*mdc;</div>
<div class="line">        <span class="keywordtype">int</span> ret=0,i;</div>
<div class="line">        <span class="keywordtype">int</span> md_type;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structx509__attributes__st.html">X509_ATTRIBUTE</a>) *sk;</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *btmp;</div>
<div class="line">        <a class="code" href="structevp__pkey__st.html">EVP_PKEY</a> *pkey;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="digest_8c.html#afe58145aa88a8ee187d858c762c00399">EVP_MD_CTX_init</a>(&amp;mdc_tmp);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="pkcs7_8h.html#a0e36637a90f6275e095126838245f911">PKCS7_type_is_signed</a>(p7) &amp;&amp; </div>
<div class="line">                                !<a class="code" href="pkcs7_8h.html#af803f5bbc7af07417d3d5b4c99ccba1a">PKCS7_type_is_signedAndEnveloped</a>(p7)) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aba0044a9c5150de1bbd77e26eab156ca">PKCS7_F_PKCS7_SIGNATUREVERIFY</a>,</div>
<div class="line">                                                <a class="code" href="pkcs7_8h.html#a368001153d8b6c97c8f120bac53b756d">PKCS7_R_WRONG_PKCS7_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        md_type=<a class="code" href="obj__dat_8c.html#a8b51f927a6f1ee63665c43ef6fc98552">OBJ_obj2nid</a>(si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#a238fa797ab7db21717ae5b4d68a925ef">digest_alg</a>-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a>);</div>
<div class="line"></div>
<div class="line">        btmp=bio;</div>
<div class="line">        <span class="keywordflow">for</span> (;;)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">if</span> ((btmp == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>) ||</div>
<div class="line">                        ((btmp=<a class="code" href="bio_8h.html#aee7bbe95cd69d7944f939d4a8073604c">BIO_find_type</a>(btmp,<a class="code" href="bio_8h.html#a4c8ef84469c42d0bedbdd75c81f777fa">BIO_TYPE_MD</a>)) == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>))</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aba0044a9c5150de1bbd77e26eab156ca">PKCS7_F_PKCS7_SIGNATUREVERIFY</a>,</div>
<div class="line">                                        <a class="code" href="pkcs7_8h.html#a984b34eb1715d23b4c12ec5d0d8666a1">PKCS7_R_UNABLE_TO_FIND_MESSAGE_DIGEST</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <a class="code" href="evp_8h.html#a0caa551c5fd31ff55117e6b55dfc54b4">BIO_get_md_ctx</a>(btmp,&amp;mdc);</div>
<div class="line">                <span class="keywordflow">if</span> (mdc == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aba0044a9c5150de1bbd77e26eab156ca">PKCS7_F_PKCS7_SIGNATUREVERIFY</a>,</div>
<div class="line">                                                        <a class="code" href="err_8h.html#ac863d0e29abbb6c480be6983fd48bf42">ERR_R_INTERNAL_ERROR</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#aaabf31f5ebaa97f5dc26e1e65f0a221e">EVP_MD_CTX_type</a>(mdc) == md_type)</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="comment">/* Workaround for some broken clients that put the signature</span></div>
<div class="line"><span class="comment">                 * OID instead of the digest OID in digest_alg-&gt;algorithm</span></div>
<div class="line"><span class="comment">                 */</span></div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#aa2be6df8c406dcdfb312833086ef54f6">EVP_MD_pkey_type</a>(<a class="code" href="evp_8h.html#a71fed39076aec9a43d618177317e3691">EVP_MD_CTX_md</a>(mdc)) == md_type)</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                btmp=<a class="code" href="bio_8h.html#ab4efedc5dfbd06141e8e08df6782ae4d">BIO_next</a>(btmp);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* mdc is the digest ctx that we want, unless there are attributes,</span></div>
<div class="line"><span class="comment">         * in which case the digest is the signed attributes */</span></div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="digest_8c.html#ab42e7b7bc6ec24356f278a660fcc61f0">EVP_MD_CTX_copy_ex</a>(&amp;mdc_tmp,mdc))</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        sk=si-&gt;auth_attr;</div>
<div class="line">        <span class="keywordflow">if</span> ((sk != <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>) &amp;&amp; (<a class="code" href="safestack_8h.html#a8d6491802d2d89d131cf226e843a4475">sk_X509_ATTRIBUTE_num</a>(sk) != 0))</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> md_dat[<a class="code" href="evp_8h.html#a71bfc78a168f00f0c4ffd2535082b129">EVP_MAX_MD_SIZE</a>], *abuf = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> md_len;</div>
<div class="line">                <span class="keywordtype">int</span> alen;</div>
<div class="line">                <a class="code" href="structasn1__string__st.html">ASN1_OCTET_STRING</a> *message_digest;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (!<a class="code" href="digest_8c.html#a3c3bec018dd4bdf73a3f14d27ea9b718">EVP_DigestFinal_ex</a>(&amp;mdc_tmp,md_dat,&amp;md_len))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                message_digest=<a class="code" href="pk7__doit_8c.html#abf8691133031089e545fe535e3b79e15">PKCS7_digest_from_attributes</a>(sk);</div>
<div class="line">                <span class="keywordflow">if</span> (!message_digest)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aba0044a9c5150de1bbd77e26eab156ca">PKCS7_F_PKCS7_SIGNATUREVERIFY</a>,</div>
<div class="line">                                        <a class="code" href="pkcs7_8h.html#a984b34eb1715d23b4c12ec5d0d8666a1">PKCS7_R_UNABLE_TO_FIND_MESSAGE_DIGEST</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">if</span> ((message_digest-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a> != (<span class="keywordtype">int</span>)md_len) ||</div>
<div class="line">                        (memcmp(message_digest-&gt;<a class="code" href="structasn1__string__st.html#a275a9784693f470debfb2b97411a4fea">data</a>,md_dat,md_len)))</div>
<div class="line">                        {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>{</div>
<div class="line"><span class="keywordtype">int</span> ii;</div>
<div class="line"><span class="keywordflow">for</span> (ii=0; ii&lt;message_digest-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a>; ii++)</div>
<div class="line">        printf(<span class="stringliteral">&quot;%02X&quot;</span>,message_digest-&gt;<a class="code" href="structasn1__string__st.html#a275a9784693f470debfb2b97411a4fea">data</a>[ii]); printf(<span class="stringliteral">&quot; sent\n&quot;</span>);</div>
<div class="line"><span class="keywordflow">for</span> (ii=0; ii&lt;md_len; ii++) printf(<span class="stringliteral">&quot;%02X&quot;</span>,md_dat[ii]); printf(<span class="stringliteral">&quot; calc\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aba0044a9c5150de1bbd77e26eab156ca">PKCS7_F_PKCS7_SIGNATUREVERIFY</a>,</div>
<div class="line">                                                        <a class="code" href="pkcs7_8h.html#a1ba522646643ebc25dfbd18fb9b0d337">PKCS7_R_DIGEST_FAILURE</a>);</div>
<div class="line">                        ret= -1;</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (!<a class="code" href="evp_8h.html#a57b33849056dfadcf1d2dc3e73022da7">EVP_VerifyInit_ex</a>(&amp;mdc_tmp,<a class="code" href="evp_8h.html#af21731974d1c9b9467b3bf209d378e36">EVP_get_digestbynid</a>(md_type), <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">                alen = <a class="code" href="asn1_8h.html#ada80d0bea54b10298b0668eabba68e9e">ASN1_item_i2d</a>((<a class="code" href="asn1_8h.html#aaa5ffa26b0bbba094a9ee353b8ade6ab">ASN1_VALUE</a> *)sk, &amp;abuf,</div>
<div class="line">                                                <a class="code" href="asn1_8h.html#a704c92967a505aaabb8a8f7065bc88d0">ASN1_ITEM_rptr</a>(PKCS7_ATTR_VERIFY));</div>
<div class="line">                <span class="keywordflow">if</span> (alen &lt;= 0) </div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aba0044a9c5150de1bbd77e26eab156ca">PKCS7_F_PKCS7_SIGNATUREVERIFY</a>,<a class="code" href="err_8h.html#ad9fba879e61994f63626b2f30e2b49ac">ERR_R_ASN1_LIB</a>);</div>
<div class="line">                        ret = -1;</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">if</span> (!<a class="code" href="evp_8h.html#adfcefdac6b22453cb99cd7c2246f8d3b">EVP_VerifyUpdate</a>(&amp;mdc_tmp, abuf, alen))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">                <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(abuf);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        os=si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#a75a871ba0bdc83cbd05822e844badf40">enc_digest</a>;</div>
<div class="line">        pkey = <a class="code" href="x509_8h.html#a97c3703b14a1f4a987c5d31cdf6cb205">X509_get_pubkey</a>(x509);</div>
<div class="line">        <span class="keywordflow">if</span> (!pkey)</div>
<div class="line">                {</div>
<div class="line">                ret = -1;</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        i=<a class="code" href="evp_8h.html#a21c0b28870fb5b630e37133f109583dd">EVP_VerifyFinal</a>(&amp;mdc_tmp,os-&gt;<a class="code" href="structasn1__string__st.html#a275a9784693f470debfb2b97411a4fea">data</a>,os-&gt;<a class="code" href="structasn1__string__st.html#a425b332bd4925320832bb18c59f6a9df">length</a>, pkey);</div>
<div class="line">        <a class="code" href="evp_8h.html#a448d9f9209a54694aff045d403850db7">EVP_PKEY_free</a>(pkey);</div>
<div class="line">        <span class="keywordflow">if</span> (i &lt;= 0)</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aba0044a9c5150de1bbd77e26eab156ca">PKCS7_F_PKCS7_SIGNATUREVERIFY</a>,</div>
<div class="line">                                                <a class="code" href="pkcs7_8h.html#a48e53eb31ba34ab3d414f1868e6f4553">PKCS7_R_SIGNATURE_FAILURE</a>);</div>
<div class="line">                ret= -1;</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">                ret=1;</div>
<div class="line">err:</div>
<div class="line">        <a class="code" href="digest_8c.html#ac6c8c38d6c8e3e274c9a974792b8342d">EVP_MD_CTX_cleanup</a>(&amp;mdc_tmp);</div>
<div class="line">        <span class="keywordflow">return</span>(ret);</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a76d0aa3f479954122b66f39c66760a0e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_SIGNER_INFO_sign </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td>
          <td class="paramname"><em>si</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__doit_8c_source.html#l00900">900</a> of file <a class="el" href="pk7__doit_8c_source.html">pk7_doit.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <a class="code" href="structenv__md__ctx__st.html">EVP_MD_CTX</a> mctx;</div>
<div class="line">        <a class="code" href="structevp__pkey__ctx__st.html">EVP_PKEY_CTX</a> *pctx;</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *abuf = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keywordtype">int</span> alen;</div>
<div class="line">        <span class="keywordtype">size_t</span> siglen;</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="structenv__md__st.html">EVP_MD</a> *md = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line"></div>
<div class="line">        md = <a class="code" href="evp_8h.html#afd1d14292f13b363355410634e00ec09">EVP_get_digestbyobj</a>(si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#a238fa797ab7db21717ae5b4d68a925ef">digest_alg</a>-&gt;<a class="code" href="structX509__algor__st.html#a79eaee9147e50e87d311ccd20f781960">algorithm</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (md == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="digest_8c.html#afe58145aa88a8ee187d858c762c00399">EVP_MD_CTX_init</a>(&amp;mctx);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#a6e42bb779758e541a2987e52223e7e50">EVP_DigestSignInit</a>(&amp;mctx, &amp;pctx, md,<a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#acac9c5af6fa0f01bb42fe39c8f2f646a">pkey</a>) &lt;= 0)</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#ac215192017d713cda37872ad4d9daf54">EVP_PKEY_CTX_ctrl</a>(pctx, -1, <a class="code" href="evp_8h.html#ad018f5b3f98b2eb5d6886e8b47dc5858">EVP_PKEY_OP_SIGN</a>,</div>
<div class="line">                                <a class="code" href="evp_8h.html#a79f48daf768296c90bcfdd16a57886b2">EVP_PKEY_CTRL_PKCS7_SIGN</a>, 0, si) &lt;= 0)</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a65786128792ee8392018116d5a3e84ee">PKCS7_F_PKCS7_SIGNER_INFO_SIGN</a>, <a class="code" href="pkcs7_8h.html#afcb1d5e8517c30bb8ea916801301aeea">PKCS7_R_CTRL_ERROR</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        alen = <a class="code" href="asn1_8h.html#ada80d0bea54b10298b0668eabba68e9e">ASN1_item_i2d</a>((<a class="code" href="asn1_8h.html#aaa5ffa26b0bbba094a9ee353b8ade6ab">ASN1_VALUE</a> *)si-&gt;auth_attr,&amp;abuf,</div>
<div class="line">                                <a class="code" href="asn1_8h.html#a704c92967a505aaabb8a8f7065bc88d0">ASN1_ITEM_rptr</a>(PKCS7_ATTR_SIGN));</div>
<div class="line">        <span class="keywordflow">if</span>(!abuf)</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#a03bbc2d5a147ccea2adb2aa8cfc43972">EVP_DigestSignUpdate</a>(&amp;mctx,abuf,alen) &lt;= 0)</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">        <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(abuf);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#a44b11e0cf78f36a8650277e36cf4a65e">EVP_DigestSignFinal</a>(&amp;mctx, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, &amp;siglen) &lt;= 0)</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">        abuf = <a class="code" href="crypto_8h.html#afdb80d14aed3b15d0ef71f72a872310d">OPENSSL_malloc</a>(siglen);</div>
<div class="line">        <span class="keywordflow">if</span>(!abuf)</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#a44b11e0cf78f36a8650277e36cf4a65e">EVP_DigestSignFinal</a>(&amp;mctx, abuf, &amp;siglen) &lt;= 0)</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="evp_8h.html#ac215192017d713cda37872ad4d9daf54">EVP_PKEY_CTX_ctrl</a>(pctx, -1, <a class="code" href="evp_8h.html#ad018f5b3f98b2eb5d6886e8b47dc5858">EVP_PKEY_OP_SIGN</a>,</div>
<div class="line">                                <a class="code" href="evp_8h.html#a79f48daf768296c90bcfdd16a57886b2">EVP_PKEY_CTRL_PKCS7_SIGN</a>, 1, si) &lt;= 0)</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a65786128792ee8392018116d5a3e84ee">PKCS7_F_PKCS7_SIGNER_INFO_SIGN</a>, <a class="code" href="pkcs7_8h.html#afcb1d5e8517c30bb8ea916801301aeea">PKCS7_R_CTRL_ERROR</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="digest_8c.html#ac6c8c38d6c8e3e274c9a974792b8342d">EVP_MD_CTX_cleanup</a>(&amp;mctx);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="asn1_8h.html#add085933f3a303f7c59acf0e9b072d63">ASN1_STRING_set0</a>(si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#a75a871ba0bdc83cbd05822e844badf40">enc_digest</a>, abuf, siglen);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line"></div>
<div class="line">        err:</div>
<div class="line">        <span class="keywordflow">if</span> (abuf)</div>
<div class="line">                <a class="code" href="crypto_8h.html#aeb21bb7e51c4f5af3bdce7226e52ca5a">OPENSSL_free</a>(abuf);</div>
<div class="line">        <a class="code" href="digest_8c.html#ac6c8c38d6c8e3e274c9a974792b8342d">EVP_MD_CTX_cleanup</a>(&amp;mctx);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Apr 15 2014 18:16:53 for openssl by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
