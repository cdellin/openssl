<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>openssl: crypto/pkcs7/pk7_smime.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">openssl
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_53403d93963d3f5d2fcffd0698f5bddb.html">crypto</a></li><li class="navelem"><a class="el" href="dir_4c2058c45cb81171e0b597ef8ac77d63.html">pkcs7</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">pk7_smime.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="cryptlib_8h_source.html">cryptlib.h</a>&quot;</code><br/>
<code>#include &lt;openssl/x509.h&gt;</code><br/>
<code>#include &lt;openssl/x509v3.h&gt;</code><br/>
</div>
<p><a href="pk7__smime_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a37471f48e14bf12857068c354b2159b4"><td class="memItemLeft" align="right" valign="top"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__smime_8c.html#a37471f48e14bf12857068c354b2159b4">PKCS7_sign</a> (<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *signcert, <a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *pkey, <a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>)*certs, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *<a class="el" href="ec__curve_8c.html#af1780c54f65adaed36d43e53ad9afe51">data</a>, int <a class="el" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>)</td></tr>
<tr class="memitem:a133af1732cf8cd0f76cc0353755b4175"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__smime_8c.html#a133af1732cf8cd0f76cc0353755b4175">PKCS7_final</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *<a class="el" href="ec__curve_8c.html#af1780c54f65adaed36d43e53ad9afe51">data</a>, int <a class="el" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>)</td></tr>
<tr class="memitem:a3295ad32e0a75d8c1ae8f650fbe53e3e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__smime_8c.html#a3295ad32e0a75d8c1ae8f650fbe53e3e">PKCS7_sign_add_signer</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *signcert, <a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *pkey, const <a class="el" href="ossl__typ_8h.html#aac66cf010326fa9a927c2a34888f45d3">EVP_MD</a> *md, int <a class="el" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>)</td></tr>
<tr class="memitem:a81fb12d4cd2e90d5edc57f221f2e2faf"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__smime_8c.html#a81fb12d4cd2e90d5edc57f221f2e2faf">PKCS7_verify</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>)*certs, <a class="el" href="ossl__typ_8h.html#a3a2b800bae08729d11bc28f12b795597">X509_STORE</a> *store, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *indata, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *<a class="el" href="ideatest_8c.html#afdf65de9e264331943a9e5a248271311">out</a>, int <a class="el" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>)</td></tr>
<tr class="memitem:a00cf9f18b18b26449b4cde33c2f1d5ff"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__smime_8c.html#a00cf9f18b18b26449b4cde33c2f1d5ff">STACK_OF</a> (<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>)</td></tr>
<tr class="memitem:a7c2ff30fbdf473de856bad0e6c92cd5e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__smime_8c.html#a7c2ff30fbdf473de856bad0e6c92cd5e">PKCS7_encrypt</a> (<a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>)*certs, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *<a class="el" href="ideatest_8c.html#a006e60e2361d5936856cf2b1883c6d61">in</a>, const <a class="el" href="ossl__typ_8h.html#a54a8663a8084d45c31f2786156b55405">EVP_CIPHER</a> *cipher, int <a class="el" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>)</td></tr>
<tr class="memitem:a2cbce26ffa134922295d7af1c5abe429"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pk7__smime_8c.html#a2cbce26ffa134922295d7af1c5abe429">PKCS7_decrypt</a> (<a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *p7, <a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *pkey, <a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *cert, <a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *<a class="el" href="ec__curve_8c.html#af1780c54f65adaed36d43e53ad9afe51">data</a>, int <a class="el" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>)</td></tr>
</table>
<h2>Function Documentation</h2>
<a class="anchor" id="a2cbce26ffa134922295d7af1c5abe429"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_decrypt </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *&#160;</td>
          <td class="paramname"><em>pkey</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *&#160;</td>
          <td class="paramname"><em>cert</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__smime_8c_source.html#l00534">534</a> of file <a class="el" href="pk7__smime_8c_source.html">pk7_smime.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *tmpmem;</div>
<div class="line">        <span class="keywordtype">int</span> ret, i;</div>
<div class="line">        <span class="keywordtype">char</span> buf[4096];</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!p7) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a00dadcaaa7ec5b5781439960671dbbc0">PKCS7_F_PKCS7_DECRYPT</a>,<a class="code" href="pkcs7_8h.html#a39c482a912e5f94bb4fa689fa40818ff">PKCS7_R_INVALID_NULL_POINTER</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="pkcs7_8h.html#a7a79261a2a0e52cc72d93c1ecf871443">PKCS7_type_is_enveloped</a>(p7)) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a00dadcaaa7ec5b5781439960671dbbc0">PKCS7_F_PKCS7_DECRYPT</a>,<a class="code" href="pkcs7_8h.html#a86bb4cc640b1bec36e1a5d082390a06e">PKCS7_R_WRONG_CONTENT_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(cert &amp;&amp; !<a class="code" href="x509_8h.html#aa2b4d3747ff3ce6998e1e1423f2c6051">X509_check_private_key</a>(cert, pkey)) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a00dadcaaa7ec5b5781439960671dbbc0">PKCS7_F_PKCS7_DECRYPT</a>,</div>
<div class="line">                                <a class="code" href="pkcs7_8h.html#a9692f5d80a13e0a41ddb58f2601ba9df">PKCS7_R_PRIVATE_KEY_DOES_NOT_MATCH_CERTIFICATE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!(tmpmem = <a class="code" href="pk7__doit_8c.html#a20b7af47df8150c9269c8066a86baac4">PKCS7_dataDecode</a>(p7, pkey, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, cert))) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a00dadcaaa7ec5b5781439960671dbbc0">PKCS7_F_PKCS7_DECRYPT</a>, <a class="code" href="pkcs7_8h.html#afe5e25c65f32672091b47542d6666145">PKCS7_R_DECRYPT_ERROR</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#ab196cc99452f23e82a6af36b9205ccf1">PKCS7_TEXT</a>) {</div>
<div class="line">                <a class="code" href="structbio__st.html">BIO</a> *tmpbuf, *bread;</div>
<div class="line">                <span class="comment">/* Encrypt BIOs can&#39;t do BIO_gets() so add a buffer BIO */</span></div>
<div class="line">                <span class="keywordflow">if</span>(!(tmpbuf = <a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bf__buff_8c.html#ad75c3eae398d1afd70f9bbd9b738e454">BIO_f_buffer</a>()))) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a00dadcaaa7ec5b5781439960671dbbc0">PKCS7_F_PKCS7_DECRYPT</a>, <a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(tmpmem);</div>
<div class="line">                        <span class="keywordflow">return</span> 0;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span>(!(bread = <a class="code" href="bio_8h.html#a4e509280cddd4eb3537fe7e3bc0827a9">BIO_push</a>(tmpbuf, tmpmem))) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a00dadcaaa7ec5b5781439960671dbbc0">PKCS7_F_PKCS7_DECRYPT</a>, <a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(tmpbuf);</div>
<div class="line">                        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(tmpmem);</div>
<div class="line">                        <span class="keywordflow">return</span> 0;</div>
<div class="line">                }</div>
<div class="line">                ret = <a class="code" href="asn1_8h.html#aa0b7d82a31e8f480bc15b164dee35b4b">SMIME_text</a>(bread, data);</div>
<div class="line">                <span class="keywordflow">if</span> (ret &gt; 0 &amp;&amp; <a class="code" href="bio_8h.html#a96ecbb07b3727908e41b304bac2586c9">BIO_method_type</a>(tmpmem) == <a class="code" href="bio_8h.html#a0626ad15cd531536cff2da2ca359aae8">BIO_TYPE_CIPHER</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <span class="keywordflow">if</span> (!<a class="code" href="evp_8h.html#ac11edd21701962dbcd2885beec28e102">BIO_get_cipher_status</a>(tmpmem))</div>
<div class="line">                                ret = 0;</div>
<div class="line">                        }</div>
<div class="line">                <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(bread);</div>
<div class="line">                <span class="keywordflow">return</span> ret;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">for</span>(;;) {</div>
<div class="line">                        i = <a class="code" href="bio_8h.html#aa9c073049884e4f84d442529a7f14861">BIO_read</a>(tmpmem, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">                        <span class="keywordflow">if</span>(i &lt;= 0)</div>
<div class="line">                                {</div>
<div class="line">                                ret = 1;</div>
<div class="line">                                <span class="keywordflow">if</span> (<a class="code" href="bio_8h.html#a96ecbb07b3727908e41b304bac2586c9">BIO_method_type</a>(tmpmem) == <a class="code" href="bio_8h.html#a0626ad15cd531536cff2da2ca359aae8">BIO_TYPE_CIPHER</a>)</div>
<div class="line">                                        {</div>
<div class="line">                                        <span class="keywordflow">if</span> (!<a class="code" href="evp_8h.html#ac11edd21701962dbcd2885beec28e102">BIO_get_cipher_status</a>(tmpmem))</div>
<div class="line">                                                ret = 0;</div>
<div class="line">                                        }</div>
<div class="line">                                        </div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line">                                }</div>
<div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="bio_8h.html#a7b4c64ffdc342154cf923744210a8429">BIO_write</a>(data, buf, i) != i)</div>
<div class="line">                                {</div>
<div class="line">                                ret = 0;</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line">                                }</div>
<div class="line">                }</div>
<div class="line">                <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(tmpmem);</div>
<div class="line">                <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a7c2ff30fbdf473de856bad0e6c92cd5e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a>* PKCS7_encrypt </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>)*&#160;</td>
          <td class="paramname"><em>certs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="ossl__typ_8h.html#a54a8663a8084d45c31f2786156b55405">EVP_CIPHER</a> *&#160;</td>
          <td class="paramname"><em>cipher</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__smime_8c_source.html#l00492">492</a> of file <a class="el" href="pk7__smime_8c_source.html">pk7_smime.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <a class="code" href="structpkcs7__st.html">PKCS7</a> *p7;</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *p7bio = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keywordtype">int</span> i;</div>
<div class="line">        <a class="code" href="structx509__st.html">X509</a> *x509;</div>
<div class="line">        <span class="keywordflow">if</span>(!(p7 = PKCS7_new())) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a0719cd581b93cbe29a88255eca0de6cb">PKCS7_F_PKCS7_ENCRYPT</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="pk7__lib_8c.html#ae1e445c765a4bfd706a4635e06714b83">PKCS7_set_type</a>(p7, <a class="code" href="obj__mac_8h.html#a4587e848643383571699c4b1fdaf5710">NID_pkcs7_enveloped</a>))</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="pk7__lib_8c.html#ac2e00954182f5e36a7506de216902a8f">PKCS7_set_cipher</a>(p7, cipher)) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a0719cd581b93cbe29a88255eca0de6cb">PKCS7_F_PKCS7_ENCRYPT</a>,<a class="code" href="pkcs7_8h.html#a945546a71b46df8514c3eded5e28674d">PKCS7_R_ERROR_SETTING_CIPHER</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="safestack_8h.html#af8495d81a6dda58254c7e12528af0118">sk_X509_num</a>(certs); i++) {</div>
<div class="line">                x509 = <a class="code" href="safestack_8h.html#a6ce8e2d1c31859b9b27cd535caba4388">sk_X509_value</a>(certs, i);</div>
<div class="line">                <span class="keywordflow">if</span>(!<a class="code" href="pk7__lib_8c.html#ae3729b075f9146ae0c8e9fed9260fac9">PKCS7_add_recipient</a>(p7, x509)) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a0719cd581b93cbe29a88255eca0de6cb">PKCS7_F_PKCS7_ENCRYPT</a>,</div>
<div class="line">                                        <a class="code" href="pkcs7_8h.html#a56e4b5e7792b27420c9bde3f3774fe7c">PKCS7_R_ERROR_ADDING_RECIPIENT</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a7c60415beebf30952a5a4141c58d8b66">PKCS7_STREAM</a>)</div>
<div class="line">                <span class="keywordflow">return</span> p7;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="pk7__smime_8c.html#a133af1732cf8cd0f76cc0353755b4175">PKCS7_final</a>(p7, in, <a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>))</div>
<div class="line">                <span class="keywordflow">return</span> p7;</div>
<div class="line"></div>
<div class="line">        err:</div>
<div class="line"></div>
<div class="line">        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(p7bio);</div>
<div class="line">        PKCS7_free(p7);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a133af1732cf8cd0f76cc0353755b4175"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_final </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__smime_8c_source.html#l00115">115</a> of file <a class="el" href="pk7__smime_8c_source.html">pk7_smime.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *p7bio;</div>
<div class="line">        <span class="keywordtype">int</span> ret = 0;</div>
<div class="line">        <span class="keywordflow">if</span> (!(p7bio = <a class="code" href="pk7__doit_8c.html#a0fb23f12a84dea91d6d0c2e9fd202e71">PKCS7_dataInit</a>(p7, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)))</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a70421a3f7591c2cb9454c9a96fe0591e">PKCS7_F_PKCS7_FINAL</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="asn1_8h.html#a9733cdb626618d20a99ee483bcfa55aa">SMIME_crlf_copy</a>(data, p7bio, <a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>);</div>
<div class="line"></div>
<div class="line">        (void)<a class="code" href="bio_8h.html#a6e1d8242b642b53ee9aefdc79ff10f3e">BIO_flush</a>(p7bio);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="pk7__doit_8c.html#adda922d753824551b5c081373ccbd8a5">PKCS7_dataFinal</a>(p7,p7bio))</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a70421a3f7591c2cb9454c9a96fe0591e">PKCS7_F_PKCS7_FINAL</a>,<a class="code" href="pkcs7_8h.html#aa26ab85783fc58af64175903269a713a">PKCS7_R_PKCS7_DATASIGN</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        ret = 1;</div>
<div class="line"></div>
<div class="line">        err:</div>
<div class="line">        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(p7bio);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"></div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a37471f48e14bf12857068c354b2159b4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a>* PKCS7_sign </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *&#160;</td>
          <td class="paramname"><em>signcert</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *&#160;</td>
          <td class="paramname"><em>pkey</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>)*&#160;</td>
          <td class="paramname"><em>certs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__smime_8c_source.html#l00068">68</a> of file <a class="el" href="pk7__smime_8c_source.html">pk7_smime.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <a class="code" href="structpkcs7__st.html">PKCS7</a> *p7;</div>
<div class="line">        <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!(p7 = PKCS7_new()))</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a2f8e691704ed63fe771a0b5803a9b040">PKCS7_F_PKCS7_SIGN</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="pk7__lib_8c.html#ae1e445c765a4bfd706a4635e06714b83">PKCS7_set_type</a>(p7, <a class="code" href="obj__mac_8h.html#a085f07bc1100332366a5675145f8fea9">NID_pkcs7_signed</a>))</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="pk7__lib_8c.html#a2e384aab05c1f8f1be396264d2fe77df">PKCS7_content_new</a>(p7, <a class="code" href="obj__mac_8h.html#a13d08edbaf91c1fd310b3e4cbd9f98a9">NID_pkcs7_data</a>))</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (pkey &amp;&amp; !<a class="code" href="pk7__smime_8c.html#a3295ad32e0a75d8c1ae8f650fbe53e3e">PKCS7_sign_add_signer</a>(p7, signcert, pkey, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>, <a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>))</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a2f8e691704ed63fe771a0b5803a9b040">PKCS7_F_PKCS7_SIGN</a>,<a class="code" href="pkcs7_8h.html#a7179b5d179769b266ad167406029c6da">PKCS7_R_PKCS7_ADD_SIGNER_ERROR</a>);</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a30a3b37b1b81d3aee3acfe0611affb48">PKCS7_NOCERTS</a>))</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="safestack_8h.html#af8495d81a6dda58254c7e12528af0118">sk_X509_num</a>(certs); i++)</div>
<div class="line">                        {</div>
<div class="line">                        <span class="keywordflow">if</span> (!<a class="code" href="pk7__lib_8c.html#aa1b853f32300f5620143c20c991d127d">PKCS7_add_certificate</a>(p7, <a class="code" href="safestack_8h.html#a6ce8e2d1c31859b9b27cd535caba4388">sk_X509_value</a>(certs, i)))</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#ab7a46f34018d9dacbb12bc5d3ccfd295">PKCS7_DETACHED</a>)</div>
<div class="line">                <a class="code" href="pkcs7_8h.html#aefb3c724892dd60578d3f5dbf5f92ae6">PKCS7_set_detached</a>(p7, 1);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; (<a class="code" href="pkcs7_8h.html#a7c60415beebf30952a5a4141c58d8b66">PKCS7_STREAM</a>|<a class="code" href="pkcs7_8h.html#a2ed1d6c5adde04aabf61604390753375">PKCS7_PARTIAL</a>))</div>
<div class="line">                <span class="keywordflow">return</span> p7;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="pk7__smime_8c.html#a133af1732cf8cd0f76cc0353755b4175">PKCS7_final</a>(p7, data, <a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>))</div>
<div class="line">                <span class="keywordflow">return</span> p7;</div>
<div class="line"></div>
<div class="line">        err:</div>
<div class="line">        PKCS7_free(p7);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a3295ad32e0a75d8c1ae8f650fbe53e3e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="pkcs7_8h.html#a827824ab5bc7870ffbc5213959710815">PKCS7_SIGNER_INFO</a>* PKCS7_sign_add_signer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a> *&#160;</td>
          <td class="paramname"><em>signcert</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a2fca4fef9e4c7a2a739b1ea04acb56ce">EVP_PKEY</a> *&#160;</td>
          <td class="paramname"><em>pkey</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="ossl__typ_8h.html#aac66cf010326fa9a927c2a34888f45d3">EVP_MD</a> *&#160;</td>
          <td class="paramname"><em>md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__smime_8c_source.html#l00161">161</a> of file <a class="el" href="pk7__smime_8c_source.html">pk7_smime.c</a>.</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">        <a class="code" href="structpkcs7__signer__info__st.html">PKCS7_SIGNER_INFO</a> *si = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structX509__algor__st.html">X509_ALGOR</a>) *smcap = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="x509_8h.html#aa2b4d3747ff3ce6998e1e1423f2c6051">X509_check_private_key</a>(signcert, pkey))</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a32ae143ca2fafb75f84b890309da68af">PKCS7_F_PKCS7_SIGN_ADD_SIGNER</a>,</div>
<div class="line">                        <a class="code" href="pkcs7_8h.html#a9692f5d80a13e0a41ddb58f2601ba9df">PKCS7_R_PRIVATE_KEY_DOES_NOT_MATCH_CERTIFICATE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!(si = <a class="code" href="pk7__lib_8c.html#ac114a621a0d530df27ad8c20f512a586">PKCS7_add_signature</a>(p7,signcert,pkey, md)))</div>
<div class="line">                {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a32ae143ca2fafb75f84b890309da68af">PKCS7_F_PKCS7_SIGN_ADD_SIGNER</a>,</div>
<div class="line">                                <a class="code" href="pkcs7_8h.html#ac9787292d4505b2326ea51517beb8d27">PKCS7_R_PKCS7_ADD_SIGNATURE_ERROR</a>);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a30a3b37b1b81d3aee3acfe0611affb48">PKCS7_NOCERTS</a>))</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">if</span> (!<a class="code" href="pk7__lib_8c.html#aa1b853f32300f5620143c20c991d127d">PKCS7_add_certificate</a>(p7, signcert))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a2653524265bfb97f5eeb770ecafef058">PKCS7_NOATTR</a>))</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">if</span> (!<a class="code" href="pk7__attr_8c.html#a53353de6198929665d55c26da1a63b6d">PKCS7_add_attrib_content_type</a>(si, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>))</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                <span class="comment">/* Add SMIMECapabilities */</span></div>
<div class="line">                <span class="keywordflow">if</span>(!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#ad63775afa99c81fc9b5bc7769a2041d2">PKCS7_NOSMIMECAP</a>))</div>
<div class="line">                        {</div>
<div class="line">                        <span class="keywordflow">if</span>(!(smcap = <a class="code" href="safestack_8h.html#a842fb6bbef61a34c4082669e43dd4080">sk_X509_ALGOR_new_null</a>()))</div>
<div class="line">                                {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a32ae143ca2fafb75f84b890309da68af">PKCS7_F_PKCS7_SIGN_ADD_SIGNER</a>,</div>
<div class="line">                                        <a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                                }</div>
<div class="line">                        <span class="keywordflow">if</span> (!add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#a720aea1da22b9537f4a540d3721e0d85">NID_aes_256_cbc</a>, -1)</div>
<div class="line">                        || !add_digest_smcap(smcap, <a class="code" href="obj__mac_8h.html#a2b8776188557eae155d3fa6a91452390">NID_id_GostR3411_94</a>, -1)</div>
<div class="line">                        || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#acbf14fbfaa2119f12d3ff9e2f1931172">NID_id_Gost28147_89</a>, -1)</div>
<div class="line">                                || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#a79a7937ec024133a05e76d7644dd8127">NID_aes_192_cbc</a>, -1)</div>
<div class="line">                                || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#a8ebaffe01b7df98d5da9d0e43edc80ac">NID_aes_128_cbc</a>, -1)</div>
<div class="line">                        || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#a8a1e8ea0dceb665cd7a19b2fb1a99ad2">NID_des_ede3_cbc</a>, -1)</div>
<div class="line">                                || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#abd186c6b6e3a641e4f1da0cf38d4bdac">NID_rc2_cbc</a>, 128)</div>
<div class="line">                                || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#abd186c6b6e3a641e4f1da0cf38d4bdac">NID_rc2_cbc</a>, 64)</div>
<div class="line">                                || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#ac6062b978d3b452f0dba5bdf37efd56f">NID_des_cbc</a>, -1)</div>
<div class="line">                                || !add_cipher_smcap(smcap, <a class="code" href="obj__mac_8h.html#abd186c6b6e3a641e4f1da0cf38d4bdac">NID_rc2_cbc</a>, 40)</div>
<div class="line">                                || !<a class="code" href="pk7__attr_8c.html#ac1b6bd2f2a862c08a942891e3110770d">PKCS7_add_attrib_smimecap</a> (si, smcap))</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                        <a class="code" href="safestack_8h.html#a36bd4e666109f68887de0ce1b8aaff5a">sk_X509_ALGOR_pop_free</a>(smcap, X509_ALGOR_free);</div>
<div class="line">                        smcap = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                        }</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a6877f5163e02a6f984c96116bd8f07f8">PKCS7_REUSE_DIGEST</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <span class="keywordflow">if</span> (!pkcs7_copy_existing_digest(p7, si))</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                        <span class="keywordflow">if</span> (!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a2ed1d6c5adde04aabf61604390753375">PKCS7_PARTIAL</a>) &amp;&amp;</div>
<div class="line">                                        !<a class="code" href="pk7__doit_8c.html#a76d0aa3f479954122b66f39c66760a0e">PKCS7_SIGNER_INFO_sign</a>(si))</div>
<div class="line">                                <span class="keywordflow">goto</span> err;</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">return</span> si;</div>
<div class="line">        err:</div>
<div class="line">        <span class="keywordflow">if</span> (smcap)</div>
<div class="line">                <a class="code" href="safestack_8h.html#a36bd4e666109f68887de0ce1b8aaff5a">sk_X509_ALGOR_pop_free</a>(smcap, X509_ALGOR_free);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        }</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a81fb12d4cd2e90d5edc57f221f2e2faf"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int PKCS7_verify </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="pkcs7_8h.html#af773f722a43f0fee6be7bfc1721c5290">PKCS7</a> *&#160;</td>
          <td class="paramname"><em>p7</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="x509v3_8h.html#a9c9204f1c9200b4c0ac4cfb65ddf0397">STACK_OF</a>(<a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>)*&#160;</td>
          <td class="paramname"><em>certs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a3a2b800bae08729d11bc28f12b795597">X509_STORE</a> *&#160;</td>
          <td class="paramname"><em>store</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>indata</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bio_8h.html#af3fabae1c9af50b9312cdff41e11d1dd">BIO</a> *&#160;</td>
          <td class="paramname"><em>out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__smime_8c_source.html#l00266">266</a> of file <a class="el" href="pk7__smime_8c_source.html">pk7_smime.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structx509__st.html">X509</a>) *signers;</div>
<div class="line">        <a class="code" href="structx509__st.html">X509</a> *signer;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structpkcs7__signer__info__st.html">PKCS7_SIGNER_INFO</a>) *sinfos;</div>
<div class="line">        <a class="code" href="structpkcs7__signer__info__st.html">PKCS7_SIGNER_INFO</a> *si;</div>
<div class="line">        <a class="code" href="structx509__store__ctx__st.html">X509_STORE_CTX</a> cert_ctx;</div>
<div class="line">        <span class="keywordtype">char</span> buf[4096];</div>
<div class="line">        <span class="keywordtype">int</span> i, j=0, <a class="code" href="ideatest_8c.html#affd277b0419eb3509477eb517aa904ce">k</a>, ret = 0;</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *p7bio;</div>
<div class="line">        <a class="code" href="structbio__st.html">BIO</a> *tmpin, *tmpout;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!p7) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#a39c482a912e5f94bb4fa689fa40818ff">PKCS7_R_INVALID_NULL_POINTER</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="pkcs7_8h.html#a0e36637a90f6275e095126838245f911">PKCS7_type_is_signed</a>(p7)) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#a86bb4cc640b1bec36e1a5d082390a06e">PKCS7_R_WRONG_CONTENT_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Check for no data and no content: no data to verify signature */</span></div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code" href="pkcs7_8h.html#a40bb355a040c7f720a34d1160c724ac9">PKCS7_get_detached</a>(p7) &amp;&amp; !indata) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#a3b5c65dd179d8c20a0dbbac79f203388">PKCS7_R_NO_CONTENT</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">/* NB: this test commented out because some versions of Netscape</span></div>
<div class="line"><span class="comment">         * illegally include zero length content when signing data.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Check for data and content: two sets of data */</span></div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="pkcs7_8h.html#a40bb355a040c7f720a34d1160c724ac9">PKCS7_get_detached</a>(p7) &amp;&amp; indata) {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#ae99b3ab38d6987338efedb2f39638c27">PKCS7_R_CONTENT_AND_DATA_PRESENT</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        sinfos = PKCS7_get_signer_info(p7);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!sinfos || !<a class="code" href="safestack_8h.html#ab2bc3323ef185811a28d36add6396d4e">sk_PKCS7_SIGNER_INFO_num</a>(sinfos)) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#ae1e635117fa6dc91f43da0ae6a60b4e3">PKCS7_R_NO_SIGNATURES_ON_DATA</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        signers = PKCS7_get0_signers(p7, certs, <a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!signers) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Now verify the certificates */</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a61a6a4fcc2595f21c83be1587858558c">PKCS7_NOVERIFY</a>)) <span class="keywordflow">for</span> (<a class="code" href="ideatest_8c.html#affd277b0419eb3509477eb517aa904ce">k</a> = 0; <a class="code" href="ideatest_8c.html#affd277b0419eb3509477eb517aa904ce">k</a> &lt; <a class="code" href="safestack_8h.html#af8495d81a6dda58254c7e12528af0118">sk_X509_num</a>(signers); <a class="code" href="ideatest_8c.html#affd277b0419eb3509477eb517aa904ce">k</a>++) {</div>
<div class="line">                signer = <a class="code" href="safestack_8h.html#a6ce8e2d1c31859b9b27cd535caba4388">sk_X509_value</a> (signers, <a class="code" href="ideatest_8c.html#affd277b0419eb3509477eb517aa904ce">k</a>);</div>
<div class="line">                <span class="keywordflow">if</span> (!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a5d7ed12d299ee2edf73f4227aaae3cc7">PKCS7_NOCHAIN</a>)) {</div>
<div class="line">                        <span class="keywordflow">if</span>(!<a class="code" href="x509__vfy_8c.html#a513e70fc82c927254c38d0ac102bafd9">X509_STORE_CTX_init</a>(&amp;cert_ctx, store, signer,</div>
<div class="line">                                                        p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;cert))</div>
<div class="line">                                {</div>
<div class="line">                                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="err_8h.html#a73974afeda3d4c0c803b60969682a13a">ERR_R_X509_LIB</a>);</div>
<div class="line">                                <a class="code" href="safestack_8h.html#a767fcef09cbbc07e5659329efcfec32c">sk_X509_free</a>(signers);</div>
<div class="line">                                <span class="keywordflow">return</span> 0;</div>
<div class="line">                                }</div>
<div class="line">                        <a class="code" href="x509__vfy_8c.html#abb33e390f015d2ba702a5e6c56388ea3">X509_STORE_CTX_set_default</a>(&amp;cert_ctx, <span class="stringliteral">&quot;smime_sign&quot;</span>);</div>
<div class="line">                } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="x509__vfy_8c.html#a513e70fc82c927254c38d0ac102bafd9">X509_STORE_CTX_init</a> (&amp;cert_ctx, store, signer, <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="err_8h.html#a73974afeda3d4c0c803b60969682a13a">ERR_R_X509_LIB</a>);</div>
<div class="line">                        <a class="code" href="safestack_8h.html#a767fcef09cbbc07e5659329efcfec32c">sk_X509_free</a>(signers);</div>
<div class="line">                        <span class="keywordflow">return</span> 0;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#aa39ab11883833ee637bc60e86d5c112a">PKCS7_NOCRL</a>))</div>
<div class="line">                        <a class="code" href="x509__vfy_8c.html#a208f8d99bd28e1587043127fe846cdc4">X509_STORE_CTX_set0_crls</a>(&amp;cert_ctx, p7-&gt;<a class="code" href="structpkcs7__st.html#a68e56125bfaf36e1332585be60752c3e">d</a>.<a class="code" href="structpkcs7__st.html#ad1a69f7c378d0594981d1f57be1a28c3">sign</a>-&gt;crl);</div>
<div class="line">                i = <a class="code" href="x509_8h.html#a00794722daae3cb1e10ec00eda7c2c62">X509_verify_cert</a>(&amp;cert_ctx);</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt;= 0) j = <a class="code" href="x509__vfy_8c.html#a0168c670323c9c346dc935ef7c0277df">X509_STORE_CTX_get_error</a>(&amp;cert_ctx);</div>
<div class="line">                <a class="code" href="x509__vfy_8c.html#a8ff79593c52dcc4c9e63bfb7146bb9e3">X509_STORE_CTX_cleanup</a>(&amp;cert_ctx);</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt;= 0) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#afe21c40ec5ee19de32c86b142a384b72">PKCS7_R_CERTIFICATE_VERIFY_ERROR</a>);</div>
<div class="line">                        <a class="code" href="err_8c.html#a89d6b806fcd20c4ea07229451d489616">ERR_add_error_data</a>(2, <span class="stringliteral">&quot;Verify error:&quot;</span>,</div>
<div class="line">                                         <a class="code" href="x509_8h.html#aca3aaed56594bd3ae0f365491844c83c">X509_verify_cert_error_string</a>(j));</div>
<div class="line">                        <a class="code" href="safestack_8h.html#a767fcef09cbbc07e5659329efcfec32c">sk_X509_free</a>(signers);</div>
<div class="line">                        <span class="keywordflow">return</span> 0;</div>
<div class="line">                }</div>
<div class="line">                <span class="comment">/* Check for revocation status here */</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Performance optimization: if the content is a memory BIO then</span></div>
<div class="line"><span class="comment">         * store its contents in a temporary read only memory BIO. This</span></div>
<div class="line"><span class="comment">         * avoids potentially large numbers of slow copies of data which will</span></div>
<div class="line"><span class="comment">         * occur when reading from a read write memory BIO when signatures</span></div>
<div class="line"><span class="comment">         * are calculated.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (indata &amp;&amp; (<a class="code" href="bio_8h.html#a96ecbb07b3727908e41b304bac2586c9">BIO_method_type</a>(indata) == <a class="code" href="bio_8h.html#a85fbb99a752fe49d342b1685580587b7">BIO_TYPE_MEM</a>))</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordtype">char</span> *ptr;</div>
<div class="line">                <span class="keywordtype">long</span> <a class="code" href="asn1_8h.html#ad8c3db4434e9cb5cd772cc009f40e856">len</a>;</div>
<div class="line">                len = <a class="code" href="bio_8h.html#ad1cca133aa21da42cf8dac755e0b4df1">BIO_get_mem_data</a>(indata, &amp;ptr);</div>
<div class="line">                tmpin = <a class="code" href="bio_8h.html#a3c93aa21db46e50b7002f434b641d218">BIO_new_mem_buf</a>(ptr, len);</div>
<div class="line">                <span class="keywordflow">if</span> (tmpin == <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>)</div>
<div class="line">                        {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                        <span class="keywordflow">return</span> 0;</div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">                tmpin = indata;</div>
<div class="line">                </div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!(p7bio=<a class="code" href="pk7__doit_8c.html#a0fb23f12a84dea91d6d0c2e9fd202e71">PKCS7_dataInit</a>(p7,tmpin)))</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#ab196cc99452f23e82a6af36b9205ccf1">PKCS7_TEXT</a>) {</div>
<div class="line">                <span class="keywordflow">if</span>(!(tmpout = <a class="code" href="bio_8h.html#a581a4f51e785ab7df2d032d38f589259">BIO_new</a>(<a class="code" href="bio_8h.html#aa00c1ff95f6d83e358d2daa6eca3e724">BIO_s_mem</a>()))) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">                <a class="code" href="bio_8h.html#a11c737cf2f36d5a7f681590b6c0a2cc3">BIO_set_mem_eof_return</a>(tmpout, 0);</div>
<div class="line">        } <span class="keywordflow">else</span> tmpout = <a class="code" href="ideatest_8c.html#afdf65de9e264331943a9e5a248271311">out</a>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* We now have to &#39;read&#39; from p7bio to calculate digests etc. */</span></div>
<div class="line">        <span class="keywordflow">for</span> (;;)</div>
<div class="line">        {</div>
<div class="line">                i=<a class="code" href="bio_8h.html#aa9c073049884e4f84d442529a7f14861">BIO_read</a>(p7bio,buf,<span class="keyword">sizeof</span>(buf));</div>
<div class="line">                <span class="keywordflow">if</span> (i &lt;= 0) <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">if</span> (tmpout) <a class="code" href="bio_8h.html#a7b4c64ffdc342154cf923744210a8429">BIO_write</a>(tmpout, buf, i);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; PKCS7_TEXT) {</div>
<div class="line">                <span class="keywordflow">if</span>(!<a class="code" href="asn1_8h.html#aa0b7d82a31e8f480bc15b164dee35b4b">SMIME_text</a>(tmpout, out)) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#aea8703cbf09dc7946bddc1147a97826d">PKCS7_R_SMIME_TEXT_ERROR</a>);</div>
<div class="line">                        <a class="code" href="bio_8h.html#abbfb67b5eb998ce232f2482b097da8b2">BIO_free</a>(tmpout);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">                <a class="code" href="bio_8h.html#abbfb67b5eb998ce232f2482b097da8b2">BIO_free</a>(tmpout);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Now Verify All Signatures */</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#affef98a01f03108ecc557311b7dba1b6">PKCS7_NOSIGS</a>))</div>
<div class="line">            <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="safestack_8h.html#ab2bc3323ef185811a28d36add6396d4e">sk_PKCS7_SIGNER_INFO_num</a>(sinfos); i++)</div>
<div class="line">                {</div>
<div class="line">                si=<a class="code" href="safestack_8h.html#a8d361c2354282f7e437265f09fef7a96">sk_PKCS7_SIGNER_INFO_value</a>(sinfos,i);</div>
<div class="line">                signer = <a class="code" href="safestack_8h.html#a6ce8e2d1c31859b9b27cd535caba4388">sk_X509_value</a> (signers, i);</div>
<div class="line">                j=<a class="code" href="pk7__doit_8c.html#a43129e7012c9aba2b945584972810198">PKCS7_signatureVerify</a>(p7bio,p7,si, signer);</div>
<div class="line">                <span class="keywordflow">if</span> (j &lt;= 0) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#a4cfe4612afa0a13ca32f44a435cbd2ec">PKCS7_F_PKCS7_VERIFY</a>,<a class="code" href="pkcs7_8h.html#a48e53eb31ba34ab3d414f1868e6f4553">PKCS7_R_SIGNATURE_FAILURE</a>);</div>
<div class="line">                        <span class="keywordflow">goto</span> err;</div>
<div class="line">                }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ret = 1;</div>
<div class="line"></div>
<div class="line">        err:</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (tmpin == indata)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">if</span> (indata) <a class="code" href="bio_8h.html#a3904b4a0c039ba9fbe4991fc08c3bd59">BIO_pop</a>(p7bio);</div>
<div class="line">                }</div>
<div class="line">        <a class="code" href="bio_8h.html#a9cc47fc222c166cd863e1dfb5467a14e">BIO_free_all</a>(p7bio);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="safestack_8h.html#a767fcef09cbbc07e5659329efcfec32c">sk_X509_free</a>(signers);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a00cf9f18b18b26449b4cde33c2f1d5ff"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STACK_OF </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="ossl__typ_8h.html#a4f666bde6518f95deb3050c54b408416">X509</a>&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="pk7__smime_8c_source.html#l00430">430</a> of file <a class="el" href="pk7__smime_8c_source.html">pk7_smime.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structx509__st.html">X509</a>) *signers;</div>
<div class="line">        <a class="code" href="safestack_8h.html#ac5f89a88ae9f79f8c27a2bf748e5fbb2">STACK_OF</a>(<a class="code" href="structpkcs7__signer__info__st.html">PKCS7_SIGNER_INFO</a>) *sinfos;</div>
<div class="line">        <a class="code" href="structpkcs7__signer__info__st.html">PKCS7_SIGNER_INFO</a> *si;</div>
<div class="line">        <a class="code" href="structpkcs7__issuer__and__serial__st.html">PKCS7_ISSUER_AND_SERIAL</a> *ias;</div>
<div class="line">        <a class="code" href="structx509__st.html">X509</a> *signer;</div>
<div class="line">        <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!p7) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aa5a567c277c796f1463a66c77c431edf">PKCS7_F_PKCS7_GET0_SIGNERS</a>,<a class="code" href="pkcs7_8h.html#a39c482a912e5f94bb4fa689fa40818ff">PKCS7_R_INVALID_NULL_POINTER</a>);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="pkcs7_8h.html#a0e36637a90f6275e095126838245f911">PKCS7_type_is_signed</a>(p7)) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aa5a567c277c796f1463a66c77c431edf">PKCS7_F_PKCS7_GET0_SIGNERS</a>,<a class="code" href="pkcs7_8h.html#a86bb4cc640b1bec36e1a5d082390a06e">PKCS7_R_WRONG_CONTENT_TYPE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Collect all the signers together */</span></div>
<div class="line"></div>
<div class="line">        sinfos = PKCS7_get_signer_info(p7);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code" href="safestack_8h.html#ab2bc3323ef185811a28d36add6396d4e">sk_PKCS7_SIGNER_INFO_num</a>(sinfos) &lt;= 0) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aa5a567c277c796f1463a66c77c431edf">PKCS7_F_PKCS7_GET0_SIGNERS</a>,<a class="code" href="pkcs7_8h.html#a1dc22fceb4f46a976b2d80edc60cf52b">PKCS7_R_NO_SIGNERS</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(!(signers = <a class="code" href="safestack_8h.html#a44ae44bd51bbf3d40058762ac4f0d377">sk_X509_new_null</a>())) {</div>
<div class="line">                <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aa5a567c277c796f1463a66c77c431edf">PKCS7_F_PKCS7_GET0_SIGNERS</a>,<a class="code" href="err_8h.html#ae17d140bd9b2b4d297015e6a260d63c2">ERR_R_MALLOC_FAILURE</a>);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="safestack_8h.html#ab2bc3323ef185811a28d36add6396d4e">sk_PKCS7_SIGNER_INFO_num</a>(sinfos); i++)</div>
<div class="line">        {</div>
<div class="line">            si = <a class="code" href="safestack_8h.html#a8d361c2354282f7e437265f09fef7a96">sk_PKCS7_SIGNER_INFO_value</a>(sinfos, i);</div>
<div class="line">            ias = si-&gt;<a class="code" href="structpkcs7__signer__info__st.html#aa50f5aaf37775fa181c551407b620d6c">issuer_and_serial</a>;</div>
<div class="line">            signer = <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">                <span class="comment">/* If any certificates passed they take priority */</span></div>
<div class="line">            <span class="keywordflow">if</span> (certs) signer = <a class="code" href="x509_8h.html#af12e92c74d1b8d870bc9082d164efd36">X509_find_by_issuer_and_serial</a> (certs,</div>
<div class="line">                                                ias-&gt;<a class="code" href="structpkcs7__issuer__and__serial__st.html#ace9f7a526b2d91328ce37a1b3d26c179">issuer</a>, ias-&gt;<a class="code" href="structpkcs7__issuer__and__serial__st.html#a46903221f3f9a3a0243bbaae23afbe98">serial</a>);</div>
<div class="line">            <span class="keywordflow">if</span> (!signer &amp;&amp; !(<a class="code" href="pkcs7_8h.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="pkcs7_8h.html#a33a9626552171dc8556a9e32527a597c">PKCS7_NOINTERN</a>)</div>
<div class="line">                        &amp;&amp; p7-&gt;d.sign-&gt;cert) signer =</div>
<div class="line">                              <a class="code" href="x509_8h.html#af12e92c74d1b8d870bc9082d164efd36">X509_find_by_issuer_and_serial</a> (p7-&gt;d.sign-&gt;cert,</div>
<div class="line">                                                ias-&gt;<a class="code" href="structpkcs7__issuer__and__serial__st.html#ace9f7a526b2d91328ce37a1b3d26c179">issuer</a>, ias-&gt;<a class="code" href="structpkcs7__issuer__and__serial__st.html#a46903221f3f9a3a0243bbaae23afbe98">serial</a>);</div>
<div class="line">            <span class="keywordflow">if</span> (!signer) {</div>
<div class="line">                        <a class="code" href="err_8h.html#a2927809edcc237b2ec4b4a4d1bfa14ce">PKCS7err</a>(<a class="code" href="pkcs7_8h.html#aa5a567c277c796f1463a66c77c431edf">PKCS7_F_PKCS7_GET0_SIGNERS</a>,<a class="code" href="pkcs7_8h.html#ac8739d03ddee7b364165ed1c0c36c977">PKCS7_R_SIGNER_CERTIFICATE_NOT_FOUND</a>);</div>
<div class="line">                        <a class="code" href="safestack_8h.html#a767fcef09cbbc07e5659329efcfec32c">sk_X509_free</a>(signers);</div>
<div class="line">                        <span class="keywordflow">return</span> 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!<a class="code" href="safestack_8h.html#a725eaf517607b2a1c8be5c25c8771003">sk_X509_push</a>(signers, signer)) {</div>
<div class="line">                <a class="code" href="safestack_8h.html#a767fcef09cbbc07e5659329efcfec32c">sk_X509_free</a>(signers);</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="e__des3_8c.html#abd96bf38ecc88042908f20aa5e5752cc">NULL</a>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> signers;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
